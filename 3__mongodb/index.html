<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://asalvadorc.github.io/BBDD_NoSQL/3__mongodb/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>3 - MongoDB - BBDD - Bases de Dades</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/extra.css" rel="stylesheet" />
        <link href="../img/favicon.ico" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "3 - MongoDB";
        var mkdocs_page_input_path = "3__mongodb.md";
        var mkdocs_page_url = "/BBDD_NoSQL/3__mongodb/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../assets/logocaminas.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">BD NoSQL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../1__introducci/">1 - Introducci贸</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">REDIS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../2__bases_de_dades_clauvalor/">2 - Bases de Dades Clau-Valor (Redis)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">MONGO</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">3 - MongoDB</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#31-estructura-json">3.1 - Estructura JSON</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#32-installacio-de-mongodb">3.2 - Instal路laci贸 de MongoDB</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#installacio-en-linux">Instal路laci贸 en Linux</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#installacio-en-windows">ワInstal路laci贸 en Windows</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#33-funcionament-de-mongodb">3.3 - Funcionament de MongoDB</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#34-utilitzacio-de-variables">3.4 - Utilitzaci贸 de variables</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#35-tipus-de-dades">3.5 - Tipus de dades</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#36-operacions-crud-basiques">3.6 - Operacions CRUD Bsiques</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#creacio-insert">Creaci贸: insert</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#lectura-find">Lectura: find</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#eliminacio-delete">Eliminaci贸: delete</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#actualitzacio-update">Actualitzaci贸 - update</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#37-operadors-dactualitzacio">3.7 - Operadors d'actualitzaci贸</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#set">$set</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#unset">$unset</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rename">$rename</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#inc">$inc</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#min">$min</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#max">$max</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mul">$mul</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#arrays">Arrays</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#actualitzacio-y">Actualitzaci贸: $ y $[]</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#insercio-push">Inserci贸: $push</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#eliminacio-pop-i-pull">Eliminaci贸: $pop i $pull</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#38-operadors-de-consulta">3.8 - Operadors de consulta</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#parametres-de-find">Parmetres de find()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#operadors">Operadors</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#operadors-de-comparacio">Operadors de comparaci贸</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#expressions-regulars">Expressions regulars</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#arrays_1">Arrays</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#recerques-en-objectes">Recerques en objectes</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#39-agregacio">3.9 - Agregaci贸</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#match">$match</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#project">$project</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#group">$group</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sort">$sort</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#limit">$limit</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#skip">$skip</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#310-resum-comandos">3.10 - Resum Comandos</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#exercicis">Exercicis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#exercici-2">Exercici 2</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercici-3">Exercici 3</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../4_relaciones_mongo/">4 - Relacions en MongoDB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../5_actividad_mongo/">Pr谩ctica Mongo</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">BBDD - Bases de Dades</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">MONGO</li>
      <li class="breadcrumb-item active">3 - MongoDB</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3-mongodb">3 - MongoDB</h1>
<p>Segurament <strong>MongoDB</strong> 茅s el m茅s fam贸s dels Sistemes Gestors de Bases de Dades
<strong>NoSQL</strong>.</p>
<p>El nom de <strong>MongoDB</strong> prov茅 de la paraula anglesa <em>hu<strong>mongo</strong>us</em>, que
significa enorme, que 茅s el prop貌sit d'aquesta Base de Dades: guardar grans
quantitats d'informaci贸. s de codi obert i est programada en C++. El va
crear l'empresa <strong>10gen</strong> (actualment <strong>MongoDB Inc.</strong>)</p>
<p>s un SGBD <strong>Documental</strong> , 茅s a dir, que servir per a guardar documents. La
manera interna de guardar-los 茅s en format <strong>BSON</strong> (Binary JSON) que en
ess猫ncia 茅s una variant del JSON per a poder guardar f铆sicament les dades
d'una manera m茅s eficient.</p>
<p>En un servidor Mongo poden haver m茅s d'una Base de Dades, encara que nosaltres
nom茅s en gastarem una: <strong>test</strong>.</p>
<ul>
<li>En cada Base de Dades la informaci贸 es guardar en <strong>col路leccions</strong>.</li>
<li>Cada col路lecci贸 constar d'uns quants <strong>documents</strong>.</li>
<li>I cada document seran una s猫rie de dades guardades en forma de <strong>clau-valor</strong> , dels tipus suportats per MongoDB, i amb el format JSON (en realitat BSON)</li>
</ul>
<p>Per tant, en Mongo no hi ha taules. Mirem uns exemples de documents JSON per a
guardar la informaci贸 de llibres i autors. Depenen de com s'haja d'accedir a
la informaci贸 ens podem plantejar guardar els llibres amb els seus autors, o
guardar els autors, amb els seus llibres. Fins i tot ens podr铆em guardar els
dos, per a poder accedir de totes les maneres, encara que 茅s a costa de doblar
la informaci贸.</p>
<p>De la primera manera, guardant els llibres amb el seu autor, podr铆em tenir
documents amb aquesta estructura, que es podrien guardar en una col路lecci贸
anomenada <strong>Llibres</strong> :</p>
<pre><code>  {  
    _id:101,  
    titol:"El secret de Khadrell",  
    autor: {  
    nom:"Pep",  
    cognoms:"Castellano Puchol",  
    any_naixement:1960  
    },  
    isbn:"84-95620-72-3"  
  },  
  {  
    _id:102,  
    titol:"L'Ombra del Vent",  
    autor: {  
    nom:"Carlos",  
    cognoms:"Ruiz Zafon",  
    pais:"Espanya"  
    },  
    pagines:490,  
    editorial:"Planeta"  
  }
</code></pre>
<p>Observeu com els objectes no tenen per qu猫 tenir la mateixa estructura. La
manera d'accedir al nom d'un autor seria aquesta: <em>objecte.autor.nom</em></p>
<p>Una manera alternativa de guardar la informaci贸, com hav铆em comentat abans
seria organitzar per autors, amb els seus llibres. D'aquesta manera podr铆em
anar omplint la col路lecci贸 <strong>Autors</strong> amb un o m茅s documents d'aquest estil:</p>
<pre><code>{  
    _id: 201,  
    nom:"Pep",  
    cognoms:"Castellano Puchol",  
    any_naixement:1960,  
    llibres: [  
    {  
      titol:"El secret de Khadrell",  
      isbn:"84-95620-72-3"  
    },  
    {  
      titol:"Habitaci贸 502",  
      editorial:"Tabarca"  
    }  
  ]  
},  
{  
    _id:202,  
    nom:"Carlos",  
    cognoms:"Ruiz Zafon",  
    pais:"Espanya",  
    llibres: [  
      {  
        titol:"L'Ombra del Vent",  
        pagines:490,  
        editorial:"Planeta"  
      }  
  ]  
}
</code></pre>
<p>Observeu com per a un autor, ara tenim un array ( els claudtors: <strong>[ ]</strong>) amb
els seus llibres.</p>
<p>Quina de les dues maneres 茅s millor per a guardar la informaci贸? Doncs dep茅n
de l'acc茅s que s'haja de fer a les dades. La millor ser segurament aquella
que depenent dels accessos que s'hagen de fer, torne la informaci贸 de forma
m茅s rpida.</p>
<h2 id="31-estructura-json">3.1 - Estructura JSON</h2>
<p>Amb JSON podrem representar:</p>
<ul>
<li><strong>Valors</strong> , de tipus <strong>carcter</strong> (entre cometes dobles), <strong>num猫ric</strong> (sense cometes) , <strong>boole</strong> (true o false) o <strong>null</strong>.</li>
<li><strong>Parelles clau valor</strong> , 茅s a dir un nom simb貌lic acompanyat d'un valor associat.. Es representen aix铆: <strong>"nom" : valor</strong></li>
<li><strong>Objectes</strong> , que 茅s una col路lecci贸 de membres, cadasc煤 dels quals pot ser una parella clau valor, o altres objectes (fins i tot arrays): es representen entre claus, i amb els elements separats per comes: <strong>{ "nom1" : "valor1" , "nom2": valor2 , valor 3 , ... }</strong></li>
<li><strong>Arrays</strong> , que s贸n llistes d'elements. Els elements no tenen per qu猫 tenir la mateixa estructura, per貌 nosaltres intentarem que s铆 que la tinguen per coher猫ncia. Cada element pot ser un valor , una parella clau valor, un objecte o un array.</li>
</ul>
<p>Veje'm algun exemples:</p>
<pre><code>{ "p1" : 2 , "p2" : 4 , "p3" : 6 , "p4" : 8 , "p5" : 10 }
</code></pre>
<p>en aquest cas tenim un objecte, l'arrel, que t茅 5 membres, tots ells parelles
clau-valor.</p>
<pre><code>{  
  "num": 1 ,  
  "nom": "Andreu" ,  
  "departament": 10 ,  
  "edat": 32 ,  
  "sou": 1000.0  
}
</code></pre>
<p>ara un objecte, l'arrel, tamb茅 amb 5 membres que s贸n parelles clau-valor.
Observeu com la clau sempre la posem entre cometes, i el valor quan 茅s un
string tamb茅, per貌 quan 茅s num猫ric, no.</p>
<pre><code>{ "empleat" :  
  { "num": 1 ,  
    "nom": "Andreu" ,  
    "departament": 10 ,  
    "edat": 32 ,  
    "sou": 1000.0  
  }  
}
</code></pre>
<p>en aquest cas tenim un objecte, l'arrel que consta d'un 煤nic objecte,
<strong>empleat</strong> , el qual consta de 5 membres clau-valor.</p>
<p>Mirem ara un exemple amb un array:</p>
<pre><code>{ "notes" :  
  [ 5 , 7 , 8 , 7 ]  
}
</code></pre>
<p>on tenim l'element arrel que consta d'un 煤nic membre, <strong>notes</strong>, que 茅s un array.</p>
<p>Tamb茅 seria correcte d'aquesta manera, per veure que l'element arrel no t茅
perqu猫 ser un objecte, sin贸 tamb茅 un array</p>
<pre><code>[ 5 , 7 , 8 , 7 ]
</code></pre>
<p>I ara un m茅s complet amb la mateixa estructura que el fitxer XML que hav铆em
vist en la pregunta 4. Tindrem un objecte arrel, amb nom茅s un objecte,
<strong>empresa</strong> , que t茅 un 煤nic element <strong>empleat</strong> que 茅s un array amb 4
elements, cadascun dels empleats:</p>
<pre><code>{ "empresa":  
  { "empleat":  
    [ {  
          "num": "1",  
          "nom": "Andreu",  
          "departament": "10",  
          "edat": "32",  
          "sou": "1000.0"  
        },  
        {  
          "num": "2",  
          "nom": "Bernat",  
          "departament": "20",  
          "edat": "28",  
          "sou": "1200.0"  
        },  
        {  
          "num": "3",  
          "nom": "Cludia",  
          "departament": "10",  
          "edat": "26",  
          "sou": "1100.0"  
        },  
        {  
          "num": "4",  
          "nom": "Dami",  
          "departament": "10",  
          "edat": "40",  
          "sou": "1500.0"  
        }
    ]  
  }  
}
</code></pre>
<p>Anem a veure un parell de casos m茅s reals. Aquesta 茅s la contestaci贸 que fa el
WebService de <strong>Bicicas</strong> en sol路licitar l'estat actual de bicicletes en els
diferents punts (en el moment de fer els apunts es consulta en l'adre莽a
<a href="http://gestiona.bicicas.es/apps/apps.php">http://gestiona.bicicas.es/apps/apps.php</a>):</p>
<pre><code>[  
  {"ocupacion":  
    [  
      {"id":"01","punto":"UJI -
      FCHS","puestos":27,"ocupados":12,"latitud":"39.99533","longitud":"-0.06999",
      "porcentajeAltaOcupacion":"80","porcentajeBajaOcupacion":"20"},  
      {"id":"02","punto":"ESTACIN DE FERROCARRIL Y
      AUTOBUSES","puestos":24,"ocupados":7,"latitud":"39.98765","longitud":"-0.05281",
      "porcentajeAltaOcupacion":"80","porcentajeBajaOcupacion":"20"},  
      {"id":"03","punto":"PLAZA DE
      PESCADERA","puestos":28,"ocupados":4,"latitud":"39.98580","longitud":"-0.03798",
      "porcentajeAltaOcupacion":"80","porcentajeBajaOcupacion":"20"},  
      ...  
    ]  
  }  
]
</code></pre>
<p>Com podeu comprovar, l'arrel no 茅s un objecte, sin贸 un <strong>Array</strong>. En l'array
nom茅s ens interessa el primer element que 茅s un objecte amb un 煤nic membre,
<strong>ocupacion</strong>(en l'exemple no hi ha m茅s elements, per貌 en poden haver m茅s en
un moment determinat, quan volen fer avisos). I <strong>ocupacion 茅s un array</strong> ,
amb <strong>un objecte per cada estaci贸 de bicicas</strong> , amb les parelles clau valor
<strong>id</strong> , <strong>punto</strong> , <strong>puestos</strong> (les bicicletes que caben), <strong>ocupados</strong>
(quantes bicicletes hi ha col路locades en aquest moment), <strong>latitud</strong> i
<strong>longitud</strong> (les coordenades), ...</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En realitat ens apareixer tota la informaci贸 molt m茅s apegada, perqu猫
realment est en una 煤nica l铆nia.</p>
<p>Per a poder observar millor l'estructura podem utilitzar un <strong>visor</strong> de json.
Normalment el navegador Firefox els visualitza b茅, encara que tamb茅 dep茅n de
la versi贸. Si tenim instal路lada una versi贸 que admet la visualitzaci贸 de JSON,
ho intentar interpretar, encara que segurament la millor manera de veure el
format JSON 茅s,tiar les opcions <strong>Dades sense processar -- &gt; Format
d'impressi贸</strong>, que 茅s la que veiem a la dreta:</p>
<table>
<thead>
<tr>
<th><img alt="" src="../T3_5_1_0_1.png" /></th>
<th><img alt="" src="../T3_5_1_0_2.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Si la versi贸 nostra de Firefox no visualitza el format JSON, podem buscar un
visor dels molts que hi ha per internet. En la figura n'hem utilitzat un, i es
pot observar com facilita molt la lectura.</p>
<p><img alt="" src="../T3_5_1_1.png" /></p>
</div>
<p>Un altre exemple. Un WebService de GeoNames (una Base de Dade geogrfica
gratu茂ta i accessible a trav茅s d'Internet) ens proporciona informaci贸 dels
llocs que troba dins d'un rectangle delimitat per un latitud al nord i al sud,
i una longitud a l'esti a l'oest (en l'exemple: nord 40.01, sud 39.9, est 0.1
i oest -0.1). Per exemple,
<a href="https://maps.googleapis.com/maps/api/geocode/json?latlng=40,0">http://api.geonames.org/citiesJSON?north=40.01&amp;south=39.99&amp;east=0.01&amp;west=-0.01&amp;lang=ES&amp;username=demo</a>
torna el seg眉ent:</p>
<pre><code>{
  "geonames": [
    {
      "lng": -0.04935,
      "geonameId": 2519752,
      "countrycode": "ES",
      "name": "Castell贸 de la Plana",
      "fclName": "city, village,...",
      "toponymName": "Castell贸 de la Plana",
      "fcodeName": "seat of a second-order administrative division",
      "wikipedia": "en.wikipedia.org/wiki/Castell%C3%B3n_de_la_Plana",
      "lat": 39.98567,
      "fcl": "P",
      "population": 180005,
      "fcode": "PPLA2"
    },
    {
      "lng": -0.06313,
      "geonameId": 2521909,
      "countrycode": "ES",
      "name": "Almazora",
      "fclName": "city, village,...",
      "toponymName": "Almassora",
      "fcodeName": "populated place",
      "wikipedia": "en.wikipedia.org/wiki/Almassora",
      "lat": 39.94729,
      "fcl": "P",
      "population": 24963,
      "fcode": "PPL"
    },
    ...
    ]
}
</code></pre>
<p>A partir de l'arrel (que ara s铆 que 茅s un objecte), tenim un membre:
<strong>geonames</strong>, que 茅s un array (un element per cada "lloc" trobat), on cada
element t茅 informaci贸 diversa, com el nom del lloc, les coordenades, la
poblaci贸, ...</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>De fa uns mesos que Google limita el servei anterior, i ha de ser amb un
usuari validat. No valdr la pena, per al poc profit que li traur铆em. Mostrem
en qu猫 consisteix el servei 煤nicament a nivell il路lustratiu</p>
</div>
<h2 id="32-installacio-de-mongodb">3.2 - Instal路laci贸 de MongoDB</h2>
<p>Podrem instal路lar MongoDB en qualsevol plataforma. I fins i tot sense tenir
permisos d'administrador, com veurem en el cas d'Ubuntu.</p>
<p>Tamb茅 est la possibilitat de crear un servidor en el n煤vol, fins i tot
gratu茂t. s l'opci贸 que ens suggereix Mongo per defecte, per貌 nosaltres no la
utilitzarem.</p>
<h3 id="installacio-en-linux">Instal路laci贸 en Linux</h3>
<p>Per a poder fer la instal路laci贸 m茅s bsica, podrem fer-lo sense permisos
d'administrador. Si els tenim tot 茅s m茅s c貌mode, per貌 si no en tenim tamb茅 ho
podem fer, com veurem i remarcarem a continuaci贸.</p>
<p><strong class="azul">Pas 1. Instal路laci贸 del servidor (Linux)</strong></p>
<p>1- De la pgina de <strong>MongoDB (<a href="https://www.mongodb.com/try/download/community">https://www.mongodb.com/try/download/community</a>)</strong> anem al men煤 <strong>Products - &gt; Comunity Edition -&gt;Comunity Server</strong>
i ens baixem la versi贸 apropiada per al nostre Sistema Operatiu. Observeu com en el cas de Linux hi ha moltes versions, per a moltes distribucions. I millor triar
el paquet <strong>tgz</strong>, ja que amb descomprimir el fitxer ser suficient. En
el cas d'<strong>Ubuntu 22.04 de 64 bits</strong> , aquest fitxer 茅s:
<strong><a href="https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2204-8.0.5.tgz">https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2204-8.0.5.tgz</a></strong>. Per貌 recordeu que us heu d'assegurar de la versi贸.  </p>
<p>2- Descomprimirem aquest fitxer on vulguem, i ja estar feta la
instal路laci贸 bsica.</p>
<p>3- Es necessari tindre un directori de dades per emmagatzemar la base de dades. Creem el directori de dades en el directori arrel (carpeta d'instal路laci贸).</p>
<pre><code>    mkdir data  
    mkdir data/db
</code></pre>
<p>4- Arranquem el servidor:</p>
<pre><code>  &lt;directori arrel Mongo&gt; /bin/mongod

  ./bin/mongod --dbpath ./data/db
</code></pre>
<p>La seg眉ent imatge il路lustra aquesta segona opci贸. Est per a una versi贸
anterior de MongoDB, per貌 茅s totalment equivalent:</p>
<p><img alt="" src="../T8_3_1_1.png" /></p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Una vegada en marxa el servidor, no hem de tancar aquesta terminal, ja que parar铆em el servidor.</p>
</div>
<p><strong class="azul">Pas 2. Instal路laci贸 del client MongoShell (Linux)</strong></p>
<p>1- De la pgina de <strong>MongoDB (<a href="https://www.mongodb.com/try/download/shell">https://www.mongodb.com/try/download/shell</a>)</strong> anem al men煤 <strong>Products - &gt; Tools -&gt;MongoDB Shell</strong>
i ens baixem la versi贸 apropiada per al nostre Sistema Operatiu. Observeu com en el cas de Linux hi ha moltes versions, per a moltes distribucions, i millor triar
el paquet <strong>tgz</strong>, ja que amb descomprimir el fitxer ser suficient. En
el cas d'<strong>Ubuntu 22.04 de 64 bits</strong> , triarem l'opi贸 gen猫rica <strong>Linux 64</strong> ja que 茅s la opci贸 que t茅 el paquet <strong>tgz</strong>, i aquest fitxer 茅s:
<strong><a href="https://downloads.mongodb.com/compass/mongosh-2.4.0-linux-x64.tgz">https://downloads.mongodb.com/compass/mongosh-2.4.0-linux-x64.tgz</a></strong>. Per貌 recordeu que us heu d'assegurar de la versi贸.</p>
<p>2- Descomprimirem aquest fitxer on vulguem, i ja estar feta la
instal路laci贸 bsica.</p>
<p>3- Per a connectar un client, obrim una segona terminal i
executem el client <strong>mongosh</strong> :</p>
<pre><code>&lt;directori arrel Mongosh&gt;/bin/mongosh

./bin/mongosh
</code></pre>
<p><img alt="" src="../T8_3_1_2.png" /></p>
<h3 id="installacio-en-windows">ワInstal路laci贸 en Windows</h3>
<p><strong class="azul">Pas 1. Instal路laci贸 del servidor (Windows)</strong></p>
<p>1- Ens baixem la versi贸 apropiada de MongoDB per a Windows, que resultar ser un .msi directament executable. En el moment de fer aquestos apunts, la versi贸 de 64 bits 茅s la 8.0.5:</p>
<p><a href="https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-8.0.5-signed.msi">https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-8.0.5-signed.msi</a></p>
<p>2- Com en el cas de Linux, abans d'executar el servidor haurem de tenir el
directori creat. Per defecte el directori ser <strong>\data\db</strong></p>
<p>3- Aqueste serien les ordres per a crear el directori i despr茅s arrancar el
servidor.</p>
<pre><code>mkdir \data\db  
C:\Program Files\MongoDB\Server\8.0\bin\mongod.exe
</code></pre>
<p>Hauria d'apar猫ixer la imatge seg眉ent</p>
<p><img alt="" src="../T8_3_1_11.png" /></p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si vas instal路lar MongoDB amb el MongoDB MSI Installer, normalment el servei ja estar instal路lat i no caldr executar-lo.</p>
</div>
<p><strong class="azul">Pas 2. Instal路laci贸 del client MongoShell (Windows)</strong></p>
<p>1- Per a connectar-nos com a clients, ho haurem de fer des d'una altra terminal,
amb <strong>mongosh.exe</strong>, que 茅s la interf铆cie de l铆nia d'ordres (CLI) oficial de MongoDB, utilitzada per interactuar amb la base de dades mitjan莽ant ordres en JavaScript:</p>
<p>Ens baixem la versi贸 apropiada de MongoDB per a Windows</p>
<p><a href="https://downloads.mongodb.com/compass/mongosh-2.4.0-linux-x64.tgz">https://downloads.mongodb.com/compass/mongosh-2.4.0-linux-x64.tgz</a></p>
<div class="admonition tip">
<p class="admonition-title">Mongo Compass</p>
<p>Tamb茅 us podeu descarregar la versi贸 <strong>MongoDB Compass</strong>, que 茅s l'eina grfica oficial de MongoDB que permet visualitzar, explorar i administrar bases de dades de MongoDB sense necessitat d'utilitzar la l铆nia de comandos.</p>
<p><a href="https://downloads.mongodb.com/compass/mongodb-compass-1.45.3-win32-x64.exe">https://downloads.mongodb.com/compass/mongodb-compass-1.45.3-win32-x64.exe</a></p>
</div>
<!--
### 3.2.1 - Connexi贸 al servidor de l'Institut

Quan hem utilitzat el client, hem executat el programa **mongo** sense posar-
li res m茅s. Per defecte s'ha connectat al servidor que tenim en la mateixa
mquina.

Per貌 en realitat li podem especificar l'adre莽a on est el servidor al qual
volem connectar. En concret, l'adre莽a del servidor de dades de l'Institut en
el qual tamb茅 tenim instal路lat MongoDB:


    mongosh  89.36.214.106

Podem connectar, per貌 no podrem fer cap operaci贸, perqu猫 est habilitada
l'autenticaci贸 per a previndre atacs, cosa que no tenim en el servidor que hem
instal路lat cadasc煤 en la seua mquina.

Aleshores, si intentem fer qualsevol operaci贸, ens donar error perqu猫 no
estem autenticats:

![](T8_3_1_1_1.png)

La manera d'autenticar ser utilitzant el comando **db.auth("_usuari"_ ,
"_contrasenya"_)**. I en connectarem a un usuari que t茅 perm铆s per a utilitzar
la BD test:

  * Usuari: **ad**
  * Contrasenya: **Ad_ieselcamina$**

A partir d'eixe moment ja podrem utilitzar-lo sense problemes:

![](T8_3_1_1_2.png)

-->

<h2 id="33-funcionament-de-mongodb">3.3 - Funcionament de MongoDB</h2>
<p>Recordeu que tindrem dues teminals:</p>
<ul>
<li>Una amb el servidor en marxa (i que no hem de tancar): <strong>mongod</strong></li>
<li>Una altra amb el client que es connecta al servidor: <strong>mongosh</strong></li>
</ul>
<p><strong class="azul">Probar el funcionament</strong></p>
<p>Per a provar el seu funcionament, anem a fer alguns comandos: </p>
<p><img alt="" src="../funcionamiento2.png" /></p>
<ul>
<li>Mostrar la versi贸 del servidor MongoDB =&gt; <code>db.version()</code>  </li>
<li>Mostrar totes les bases de dades en el teu servidor MongoDB =&gt; <code>show dbs</code></li>
<li>Mostrar el nom de la BD del servidor MongoDB =&gt; <code>db.getName()</code>  </li>
<li>Mostrar totes les col路leccions en la base de dades seleccionada =&gt; <code>show collections</code></li>
</ul>
<h2 id="34-utilitzacio-de-variables">3.4 - Utilitzaci贸 de variables</h2>
<p>Com comentvem el que m茅s utilitzarem del llenguatge <strong>Javascript</strong> 茅s la
utilitzaci贸 de variables, que ens pot ser molt 煤til en algunes ocasions.
Podrem utilitzar-les durant la sessi贸, per貌 evidentment no perduraran d'una
sessi贸 a l'altra.</p>
<p>Per a definir una variable podem posar opcionalment davant la paraula
reservada <strong>var</strong> , per貌 no 茅s necessari. Posarem el nom de la variable, el
signe igual, i a continuaci贸 el valor de la variable, que pot ser una
constant, o una expressi贸 utilitzant constants, operadors, altres variables,
funcions de Javascript, ...</p>
<p>Especialment interessant s贸n les variables que poden contenir un document
JSON.</p>
<pre><code>Per exemple:
  &gt; a = 30  
  30  
  &gt; b = a/4  
  7.5  
  &gt; Math.sqrt(b)  
  2.7386127875258306  
  &gt; doc = {camp1: "Hola", camp2: 45, camp3: new Date()}  
  {  
    "camp1" : "Hola",  
    "camp2" : 45,  
    "camp3" : ISODate("2022-01-16T18:07:51.118Z")  
  }  
  &gt;
</code></pre>
<p>Una variable de tipus JSON es podr modificar molt fcilment, tota ella, o
algun dels elements. Per a arribar als elements posarem
<strong><em>nom_variable.nom_camp</em></strong> :</p>
<pre><code>&gt; doc.camp4 = 3.141592  
3.141592


&gt; doc.camp5 = [ 2 , 4 , 6 , 8]  
[ 2, 4, 6, 8 ]
</code></pre>
<p>I si ara intentem traure el contingut de la variable:</p>
<pre><code>&gt; doc  
{  
  "camp1" : "Hola",  
  "camp2" : 45,  
  "camp3" : ISODate("2022-01-16T18:07:51.118Z"),  
  "camp4" : 3.141592,  
  "camp5" : [  
              2,  
              4,  
              6,  
              8  
    ]  
}  
&gt;
</code></pre>
<p>Tamb茅 hem de fer constar que en un document, que ser de tipus JSON
(prcticament), ser un conjunt de parelles clau-valor, amb algunes
restriccions:</p>
<ul>
<li>El document (que moltes vegades l'associarem a objecte de JSON) va entre claus ( <strong>{ }</strong> )</li>
<li>Els elements d'un objecte van separats per comes, i s贸n parelles clau-valor.</li>
<li>La clau no pot ser nula, ni repetir-se en el mateix objecte (s铆 en diferents objectes, clar)</li>
<li>Els valors s贸n dels tipus que veurem en l'apartat seg眉ent.</li>
<li>Un document guardat ha de contenir obligat貌riament un camp anomenat <strong>_id</strong> , i que contindr un valor 煤nic en la col路lecci贸 i servir per a identificar-lo. Si en guardar un document no li hem posat camp <strong>_id</strong> , el generar automticament MongoDB.</li>
</ul>
<h2 id="35-tipus-de-dades">3.5 - Tipus de dades</h2>
<p>Els valors dels elements, 茅s a dir de les parelles clau valor, poden ser d'uns
quants tipus. Fem un rpid reps.</p>
<p>En els exemples que van a continuaci贸 definim senzillament parelles clau-valor
dels diferents tipus, o en tot cas ens ho guardem en variables, per貌 no
guardarem encara en la Base de Dades (ho farem en la seg眉ent pregunta).</p>
<p>Quan guardem en una variable es mostrar el prompt, la definici贸 de la
variable i despr茅s el resultat d'haver guardat la variable. Utilitzarem
requadres blancs. Els requadres grocs s贸n 煤nicament de la definici贸 d'una
clau-valor d'un determinat tipus</p>
<p><strong class="azul">NULL</strong></p>
<p>M茅s que un tipus de dades 茅s un valor, millor dit, l'abs猫ncia de valor</p>
<pre><code>{ "x" : null }
</code></pre>
<p><strong class="azul">BOOLEAN</strong></p>
<p>El tipus boole, que pot agafar els valors true o false.</p>
<pre><code>{ "x" : true }

{ "y" : false }
</code></pre>
<p><strong class="azul">NUMBER</strong></p>
<p>Per defecte, el tiups de dades num猫rics ser el de coma flotant (<strong>float</strong>),
simple precisi贸. Si volem un altre tiups (enter, doble precisi贸, ...) ho
haurem d'indicar expressament. Aix铆 els dos seg眉ents valors s贸n float:</p>
<pre><code>{ "x" : 3.14 }

{ "y" : 3 }
</code></pre>
<p>Si volem que siga estrictament enter, per exemple, haurem d'utilitzar una
funci贸 de conversi贸:</p>
<pre><code>{ "x" : NumberDouble("3.14") }

{ "y" : NumberInt("3") }
</code></pre>
<p><strong class="azul">STRING</strong></p>
<p>Es pot guardar qualsevol cadena amb carcters de la codificaci贸 UTF-8</p>
<pre><code>{ x : "Hola, qu猫 tal?"}
</code></pre>
<p><strong class="azul">DATE</strong></p>
<p>Es guarda data i hora, i internament es guarden en milisegons des de l'any
inicial. No es guarda el <strong><em>Time zone</em></strong> , 茅s a dir, la desviaci贸 respecte a
l'hora internacional.</p>
<pre><code>{ x : ISODate("2022-01-16T11:15:27.471Z") }
</code></pre>
<p>Normalment utilitzarem funcions de tractament de la data-hora. L'anterior era
per a convertir el string en data-hora. La seg眉ent 茅s per a obtenir la data-
hora actual:</p>
<pre><code>{ x : new Date() }
</code></pre>
<p>s a dir, que si no posem parmetre, ens d贸na la data-hora actual. Per貌 li
podem posar com a parmetre la data-hora que volem que genere. En aquest
exemple, nom茅s posem data, per tant l'hora ser les 00:00:</p>
<pre><code>&gt; z = new Date("2022-01-16")  
ISODate("2022-01-16T00:00:00Z")
</code></pre>
<p>En aquest s铆 que posem una determinada hora, i observeu com hem deposar la T
(Time) entre el dia i l'hora:</p>
<pre><code>&gt; z = new Date("2022-02-16T18:00")  
ISODate("2022-01-16T18:00:00Z")
</code></pre>
<p>s molt important que posem sempre <strong>New Date()</strong> per a generar una data-hora.
Si posem 煤nicament <strong>Date()</strong> , el que estem generant 茅s un string (segurament
amb la data i hora actual, per貌 un string):</p>
<pre><code>&gt; z = Date("2022-01-16")  
Sun Jan 16 2022 22:20:09 GMT+0100 (CET)
</code></pre>
<p><strong class="azul">ARRAY</strong></p>
<p>s un conjunt d'elements, cadascun de qualsevol tipus, encara que el m茅s
habitual 茅s que siguen del mateix tipus. Van entre claudtors (<strong>[ ]</strong>) i els
elements separats per comes.</p>
<pre><code>{ x : [ 2 , 4 , 6 , 8 ] }
</code></pre>
<p>Com comentvem, cada element de l'array pot ser de qualsevol tipus:</p>
<pre><code>{ y : [ 2 , 3.14 , "Hola" , new Date() ] }
</code></pre>
<p>En MongoDB podrem treballar molt b茅 amb arrays, i tindrem operacions per a
poder buscar dins de l'array, modificar un element, crear 铆ndex, ...</p>
<p><strong class="azul">DOCUMENTS (OBJECTES)</strong></p>
<p>Els documents poden contenir com a elements uns altres documents (<strong>objectes</strong>
en la terminologia JSON, per貌 <strong>documents</strong> en la terminologia de MongoDB).</p>
<p>Van entre claus ( <strong>{ }</strong> ), i els elements que contindran van separats per
comes i seran parelles clau-valor de qualsevol tipus (fins i tot altres
documents).</p>
<pre><code>{ x : { a : 1 , b : 2 } }
</code></pre>
<p>Posar documents dins d'uns altres documents (el que s'anomena <em>embedded</em>
<em>document</em>) ens permet guardar la informaci贸 d'una manera m茅s real, no tan
plana. Aix铆 per exemple, les dades d'una persona les podr铆em definir de la
seg眉ent manera. Les posarem en una variable, per veure despr茅s com podem
accedir als diferents elements, encara que el m茅s normal ser guardar-lo en la
Base de Dades (amb <strong>insert()</strong>). Si copiem el que va a
continuaci贸 al terminal de Mongo, ens apareixer amb un format estrany. s
perqu猫 la sent猫ncia d'assignaci贸 a la variable ocupa m茅s d'una l铆nia, i
apareixeran 3 punts al principi per a indicar que continua la sent猫ncia. Per貌
funcionar perfectament :</p>
<pre><code>doc = {  
  nom:"Joan Mart铆",  
  adre莽a: {  
  carrer:"Major",  
  n煤mero:1,  
  poblaci贸:"Castell贸"  
  } ,  
  tel猫fons : [964223344,678345123]  
}
</code></pre>
<p>Observeu com aquesta estructura que ha quedat tan clara, segurament en una
Base de Dades Relacional ens hauria tocat guardar en 3 taules: la de persones,
la d'adreces i la de tel猫fons.</p>
<p>Per a accedir als elements d'un document posvem el punt. Doncs el mateix per
als elements d'un document dins d'un document. I tamb茅 podem accedir als
elements d'un array, posant l'铆ndex entre claudtors.</p>
<pre><code>  &gt; doc.nom  
  Joan Mart铆

  &gt; doc.adre莽a  
  { "carrer" : "Major", "n煤mero" : 1, "poblaci贸" : "Castell贸" }

  &gt; doc.adre莽a.carrer  
  Major

  &gt; doc.tel猫fons  
  [ 964223344, 678345123 ]

  &gt; doc.tel猫fons[0]  
  964223344
</code></pre>
<p><strong class="azul">OBJECT ID</strong></p>
<p>s un tipus que defineix MongoDB per a poder obtenir valors 煤nics. s el valor
per defecte de l'element <strong>_id</strong> , necessari en tot document (atenci贸: en un
document, no en un element de tipus document que hem dit equivalent a
l'objecte de JSON). s un n煤mero long, 茅s a dir que utilitza 24 bytes.</p>
<p>Farem proves de la seua utilitzaci贸 en la se眉ent pregunta, en el moment
d'inserir diferents documents.</p>
<h2 id="36-operacions-crud-basiques">3.6 - Operacions CRUD Bsiques</h2>
<p>En aquest punt anem a veure les operacions m茅s bsiques, per a poder treballar
sobre exemples prctics, i aix铆 disposar ja d'unes dades inicials per a
practicar.</p>
<h3 id="creacio-insert">Creaci贸: insert</h3>
<p>MongoDB proporciona els  m猫todes seg眉ents per inserir documents en una col路lecci贸:</p>
<ul>
<li>
<p>db.collection.<strong>insertOne()</strong></p>
</li>
<li>
<p>db.collection.<strong>insertMany()</strong></p>
</li>
</ul>
<p><img alt="" src="../T8_insert.png" /></p>
<p>La funci贸 <strong>insert</strong> afegir documents a una col路lecci贸. En el parmetre posem
el document directament, o una variable que continga el document. Si la
col路lecci贸 no existia, la crear i despr茅s afegir el document. En la seg眉ent
sent猫ncia estem treballant sobre la col路lecci贸 <strong>exemple</strong> , que segurament ja
existir de quan vam fer la pregunta 3.1 d'instal路laci贸 de MongoDB, que per a
provar vam inserir un document. Per貌 si no existia, la crear sense problemes.</p>
<pre><code>&gt; db.exemple.insertOne({ msg : "Hola, qu猫 tal?"})
</code></pre>
<p>Acabem d'inserir un nou document, i aix铆 ens ho avisa ( <strong>{ "nInserted" : 1
}</strong> , s'ha inserit un document). Automticament haur creat un element <strong>_id</strong>
de tipus <strong>ObjectId</strong> , ja que li fa falta per a identificar el document entre
tots els altres de la col路lecci贸.</p>
<p>Insertem un altre document:</p>
<pre><code>    &gt; db.exemple.insertOne({ msg2 : "Com va la cosa?"})
</code></pre>
<p>I en aquest exemple ens guardem el document en la variable <strong>doc</strong> , i despr茅s
l'inserim</p>
<pre><code>&gt; doc = { msg3 : "Per ac铆 no ens podem queixar ..."}

&gt; db.exemple.insertOne(doc)
</code></pre>
<p>Tamb茅 ens indica que ha inserit un document. I haur creat tamb茅 el camp
<strong>_id</strong> com veurem en el seg眉ent punt.</p>
<p><strong class="azul">Inserci贸 especificant el id</strong></p>
<p>En els document que hem inserit fins el moment, no hem especificat el camp
<strong>_id</strong> , i Mongo l'ha generat automticament de tipus <strong>ObjectId</strong>.</p>
<p>Per貌 nosaltres podrem posar aquest camp <strong>_id</strong> amb el valor que vulguem. Aix貌
s铆, haurem d'estar segurs que aquest valor no l'agafa cap altre document de la
col路lecci贸, o ens donar un error.</p>
<p>Aix铆 per exemple anem a inserir la informaci贸 d'uns alumnes. Els posarem en
una col路lecci贸 nova anomenada <strong>alumnes</strong> , i els intentarem posar un <strong>_id</strong>
personal. Per exemple posarem els n煤meros 51, 52, 53, ...</p>
<pre><code>&gt; db.alumnes.insertOne ({_id: 51 , nom: "Rebeca" , cognoms: "Mart铆 Peral"})
</code></pre>
<p>Ha anat b茅, i si mirem els documents que tenim en la col路lecci贸, comprovarem
que ens ha respectat el <strong>_id</strong> :</p>
<pre><code>&gt; db.alumnes.find()

{ "_id" : 51, "nom" : "Rebeca", "cognoms" : "Mart铆 Peral" }
</code></pre>
<p>Per貌 si intentem inserir un altre document amb el mateix <strong>_id</strong> (51), ens
donar error:</p>
<pre><code>&gt; db.alumnes.insertOne ({_id: 51 , nom: "Raquel" , cognoms: "Gomis Arnau"})

WriteResult({  
"nInserted" : 0,  
"writeError" : {  
    "code" : 11000,  
    "errmsg" : "E11000 duplicate key error collection: test.alumnes index: _id_
    dup key: { : 51.0 }"  
  }  
})  
&gt;
</code></pre>
<p>Ens avisa que estem duplicant la <em>clau</em> <em>principal</em> , 茅s a dir
l'identificador.</p>
<p><strong class="azul">Inserci贸 m煤ltiple</strong></p>
<p>Quan els documents que volem inserir s贸n senzills, podem inserir m茅s d'un a la
vegada, posant dis del <strong>insertMany()</strong> un <strong>array</strong> amb tots els elements. En el
seg眉ent exemple creem uns quants nombres primers en la col路lecci贸 del mateix
nom:</p>
<pre><code>&gt; db.nombresprimers.insertMany( [ {_id:2} , {_id:3} , {_id:5} , {_id:7} , {_id:11}
&gt; , {_id:13} , {_id:17} , {_id:19} ] )

BulkWriteResult({  
    "writeErrors" : [ ],  
    "writeConcernErrors" : [ ],  
    "nInserted" : 8,  
    "nUpserted" : 0,  
    "nMatched" : 0,  
    "nModified" : 0,  
    "nRemoved" : 0,  
    "upserted" : [ ]  
})  
&gt;
</code></pre>
<p>Ens avisa que ha fet 8 insercions, i ac铆 els tenim:</p>
<pre><code>&gt; db.nombresprimers.find()  
{ "_id" : 2 }  
{ "_id" : 3 }  
{ "_id" : 5 }  
{ "_id" : 7 }  
{ "_id" : 11 }  
{ "_id" : 13 }  
{ "_id" : 17 }  
{ "_id" : 19 }  
&gt;
</code></pre>
<h3 id="lectura-find">Lectura: find</h3>
<p>MongoDB ofereix els m猫todes seg眉ents per llegir documents d'una col路lecci贸:</p>
<ul>
<li>db.collection.<strong>find()</strong></li>
</ul>
<p>recuperar tots els documents de la col路lecci贸, encara que podrem posar criteris per a que ens torne tots els documents que acomplesquen aquestos criteris (ho veurem m茅s avant).</p>
<p><img alt="" src="../T8_find.png" /></p>
<p>Exemple:</p>
<pre><code>&gt; db.exemple.find()  
{ "_id" : ObjectId("56ce310bc61e04ba81def50b"), "msg" : "Hola, qu猫 tal?" }  
{ "_id" : ObjectId("56ce31f6c61e04ba81def50c"), "msg2" : "Com va la cosa?" }  
{ "_id" : ObjectId("56ce3237c61e04ba81def50d"), "msg3" : "Per ac铆 no ens podem queixar ..." }  
&gt;
</code></pre>
<p>En tots els casos podem comprovar que 茅s cert el que ven铆em afirmant, que ha
creat automticament l'element <strong>_id</strong> per a cada document guardat.
Evidentment, cadasc煤 de nosaltres tindr una valors diferents.</p>
<h3 id="eliminacio-delete">Eliminaci贸: delete</h3>
<p>Per a esborrar un document d 'una col路lecci贸 utilitzarem la funci贸 <strong>deleteOne</strong>
, passant-li com a parmetre la condici贸 del document o documents a esborrar. MongoDB ofereix els m猫todes seg眉ents per eliminar documents d'una col路lecci贸:</p>
<ul>
<li>
<p>db.collection.<strong>deleteOne()</strong></p>
</li>
<li>
<p>db.collection.<strong>deleteMany()</strong></p>
</li>
</ul>
<p><img alt="" src="../T8_delete.png" /></p>
<pre><code>&gt; db.nombresprimers.deleteOne( {"_id" : 19} )
</code></pre>
<p>Ens avisa que ha esborrat un document.</p>
<p>La condici贸 no cal que siga sobre el camp <strong>_id</strong>. Pot ser sobre qualsevol
camp, <strong>i esborrar tots els que coincideixen</strong>.</p>
<pre><code>&gt; db.exemple.deleteMany( {"msg3" : "Per ac铆 no ens podem queixar ..."} )
</code></pre>
<p>Tamb茅 tenim la possibilitat d'esborrar tota una col路lecci贸 amb la funci贸
<strong>drop()</strong>. Pareu atenci贸 perqu猫 茅s molt senzilla d'eliminar, i per tant,
potencialment molt perillosa.</p>
<pre><code>&gt; db.nombresprimers.drop()  
true  
&gt;
</code></pre>
<h3 id="actualitzacio-update">Actualitzaci贸 - update</h3>
<p>La funci贸 <em><strong>update</strong></em> servir per a actualitzar un document ja guardat.
Tindr dos parmetres:</p>
<ul>
<li>El primer parmetre ser la condici贸 per a trobar el document que s'ha d'actualitzar.</li>
<li>El segon parmetre ser el nou document que substituir l'anterior</li>
</ul>
<p>MongoDB ofereix els m猫todes seg眉ents per actualitzar els documents d'una col路lecci贸:</p>
<ul>
<li>
<p>db.collection.<strong>updateOne()</strong></p>
</li>
<li>
<p>db.collection.<strong>updateMany()</strong></p>
</li>
<li>
<p>db.collection.<strong>replaceOne()</strong></p>
</li>
</ul>
<p><img alt="" src="../T8_update.png" /></p>
<p>Per exemple, si mirem les dades actuals:</p>
<pre><code>&gt; db.exemple.find()  
{ "_id" : ObjectId("56ce310bc61e04ba81def50b"), "msg" : "Hola, qu猫 tal?" }  
{ "_id" : ObjectId("56ce31f6c61e04ba81def50c"), "msg2" : "Com va la cosa?" }
</code></pre>
<p>Podem comprovar el contingut del segon document, el que te <strong>msg2</strong>. Anem a
modificar-lo: en el primer parmetre posem condici贸 de recerca (nom茅s hi haur
un) i en el segon posem el nou document que substituir l'anterior amb el parmetre <strong>$set</strong>.</p>
<pre><code>&gt; db.exemple.updateOne( {msg2:"Com va la cosa?"} , {$set: {msg2:"Qu猫? Com va la cosa?"}})
</code></pre>
<p>Observeu que la contestaci贸 del <strong>update</strong><strong>()</strong> 茅s que ha fet <strong>match</strong> (hi
ha hagut coincid猫ncia) amb un document, i que ha modificat un. Si no en troba
cap, no donar error, senzillament dir que ha fet match amb 0 documents, i
que ha modificat 0 documents. Mirem com efectivament ha canviat el segon
document</p>
<pre><code>&gt; db.exemple.find()  
{ "_id" : ObjectId("56ce310bc61e04ba81def50b"), "msg" : "Hola, qu猫 tal?" }  
{ "_id" : ObjectId("56ce31f6c61e04ba81def50c"), "msg2" : "Qu猫? Com va la cosa?" }
</code></pre>
<p>Ens vindran molt b茅 les variables per a les actualitzacions, ja que en moltes
ocasions ser modificar lleugerament el document, canviant o afegint algun
element. Ho podrem fer c貌modament amb la variable: primer guardem el document
a modificar en una variable; despr茅s modifiquem la variable; i per 煤ltim fem
l'operaci贸 d'actualitzaci贸. Evidentment si tenim alguna variable amb el
contingut del document ens podr铆em estalviar el primer pas.</p>
<pre><code>&gt; doc1 = db.exemple.find()  
{ "_id" : ObjectId("56ce310bc61e04ba81def50b"), "msg" : "Hola, qu猫 tal?" }

&gt; doc1.titol = "Missatge 1"  
Missatge 1

&gt; db.exemple.updateOne( {msg:"Hola, qu猫 tal?"} , doc1)  
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

&gt; db.exemple.findOne()  
{  
  "_id" : ObjectId("56ce310bc61e04ba81def50b"),  
  "msg" : "Hola, qu猫 tal?",  
  "titol" : "Missatge 1"  
}  
&gt;
</code></pre>
<p><strong class="azul">Reempla莽ar un document</strong></p>
<p>Per reempla莽ar tot el contingut d'un document excepte el _id, passeu un document completament nou com a segon argument a Collection.<strong>replaceOne()</strong>.</p>
<p>En reempla莽ar un document, aquest ha de constar 煤nicament de parells camp-valor. No podeu incloure expressions d'operadors d'actualitzaci贸.  </p>
<p>El document de substituci贸 pot tenir camps diferents dels del document original. Al document de reempla莽ament, podeu ometre el _id, ja que _id es immutable. No obstant aix貌, si l'inclou _id, heu de tenir el mateix valor que l'actual.</p>
<pre><code>db.exemple.replaceOne(
  { "msg" : "Hola, qu猫 tal?" },
  { "msg" : "Hola, qu猫 tal?" , "titol2" : "Missatge 2" }
)
</code></pre>
<h2 id="37-operadors-dactualitzacio">3.7 - Operadors d'actualitzaci贸</h2>
<p>En el apartat anterior hem vist l'actualitzaci贸 de documents ja
existents a la Base de Dades. Aquesta actualitzaci贸 la f茅iem modificant tot el
document, encara que tenim la variant de guardar el document en una variable,
modificar aquesta variable i despr茅s fer l'actualitzaci贸 amb aquesta variable.
Per貌 observeu que continua sent una modificaci贸 de tot el document, una
substituci贸 del document antic per un document nou.</p>
<p>En aquest apartat veurem la utilitzaci贸 d'uns modificadors (<em>modifiers</em>) de
l'operaci贸 <strong>update()</strong>, que ens permetran modificar documents de forma
potent: creant i eliminant claus (elements) d'un document, o canviant-los, i
fins i tot afegir o eliminar elements d'un array.</p>
<h3 class="azul" id="set">$set</h3>
<p>El modificador <strong>$set</strong> assigna un valor a un camp del document seleccionat de
la Base de Dades. Si el camp ja existia, modificar el valor, i si no existia
el crear.</p>
<p>La sintaxi del modificador <strong>$set</strong> 茅s la seg眉ent:</p>
<pre><code>{ $set : { clau : valor} }
</code></pre>
<p>Per貌 recordeu que 茅s un modificador, i l'hem d'utilitzar dins d'una operaci贸
d'actualitzaci贸. Anir en el segon parmetre del <strong>update()</strong> , i per tant amb
aquestos modificadors ja no posem tot el document en el segon parmetre, sin贸
煤nicament l'operador de modificaci贸.</p>
<p>Mirem-ho millor en un exemple:</p>
<pre><code>&gt; db.alumnes.insertOne( {nom:"Abel", cognoms:"Bernat Carrera"} )


&gt; db.alumnes.find()  
{  
  "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
  "nom" : "Abel",  
  "cognoms" : "Bernat Carrera"  
}  
&gt;
</code></pre>
<p>Suposem ara que li volem afegir l'edat. Abans ho far铆em guardant el document
en una variable, i afegint el camp, per a guardar despr茅s. Ara ho tenim m茅s
fcil:</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $set: {edat:21} } )
</code></pre>
<p>Ha trobat un, i l'ha modificat. Evidentment, si hi haguera m茅s d'un alumne a
mb el nom Abel, els modificaria tots.</p>
<pre><code>&gt; db.alumnes.find()  
{  
  "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
  "nom" : "Abel",  
  "cognoms" : "Bernat Carrera",  
  "edat" : 21  
}
</code></pre>
<p>Es pot especificar m茅s d'un camp amb els valor corresponents. Si no existien
es crearan, i si ja existien es modificaran:</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $set: {nota: 8.5 , edat:22} } )

&gt; db.alumnes.find()  
{  
  "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
  "nom" : "Abel",  
  "cognoms" : "Bernat Carrera",  
  "edat" : 22,  
  "nota" : 8.5  
}
</code></pre>
<p>I fins i tot es pot canviar el tipus d'un camp determinat, i utilitzar arrays,
i objectes, ...</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $set: {nota: [8.5,7.5,9], adre莽a:{carrer:"Major",numero:7,cp:"12001"} } } )


&gt; db.alumnes.find()  
{  
  "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
  "nom" : "Abel",  
  "cognoms" : "Bernat Carrera",  
  "edat" : 22,  
  "nota" : [  
      8.5,  
      7.5,  
      9  
  ],  
  "adre莽a" : {  
      "carrer" : "Major",  
      "numero" : 7,  
      "cp" : "12001"  
  }  
}
</code></pre>
<p>Podem fins i tot modificar ara nom茅s el valor d'un camp d'un objecte del
document. Per exemple, anem a modificar el codi postal de l'anterior alumne.
La manera d'arribar al codi postal ser <strong>adre莽a.cp</strong> , per貌 haurem d'anar amb
compte que vaja entre cometes per a que el trobe:</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $set: {adre莽a.cp:"12502"} } )

uncaught exception: SyntaxError: missing : after property id :  
@(shell):1:49

&gt; db.alumnes.updateOne( {nom:"Abel"} , { $set: {"adre莽a.cp":"12502"} } )

&gt; db.alumnes.find()  
{  
  "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
  "nom" : "Abel",  
  "cognoms" : "Bernat Carrera",  
  "edat" : 22,  
  "nota" : [  
        8.5,  
        7.5,  
        9  
  ],  
  "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
  }  
}
</code></pre>
<h3 class="azul" id="unset">$unset</h3>
<p>El modificador <strong>$unset</strong> servir per a <strong>eliminar</strong> elements (camps) d'un o
uns documents. Si el camp existia, l'eliminar, i si no existia, no donar
error (avisar que s'han modificat 0 documents).</p>
<p>La sintaxi 茅s:</p>
<pre><code>{ $unset : {camp : 1 } }
</code></pre>
<p>Haurem de posar un valor al camp que anem a esborrar per a mantenir la sintaxi
correcta, i posem 1 que equival a true. Tamb茅 podr铆em posar -1, que equival a
false, per貌 aleshores no l'esborraria, i per tant no far铆em res. Sempre
posarem 1.</p>
<p>Mirem el seg眉ent exemple. Afegim un camp, que ser el n煤mero d'ordre, i
despr茅s el llevarem.</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $set: {num_ordre:10} } )

&gt; db.alumnes.find()  
{  
  "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
  "nom" : "Abel",  
  "cognoms" : "Bernat Carrera",  
  "edat" : 22,  
  "nota" : [  
        8.5,  
        7.5,  
        9  
  ],  
  "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
  },  
  "num_ordre" : 10  
}

&gt; db.alumnes.updateOne( {nom:"Abel"} , { $unset: {num_ordre:1} } )

&gt; db.alumnes.updateOne( {nom:"Abel"} , { $unset: {puntuacio:1} } )
</code></pre>
<p>Hem afegit primer el camp <strong>num_ordre</strong> , i hem mostrat el document per
comprovar que existeix. Despr茅s esborrem el camp <strong>num_ordre</strong> (i ens confirma
que ha modificat un document). Despr茅s intentem esborrar un camp que no
existeix, <strong>puntuacio</strong>. No d贸na error, per貌 ens avisa que ha modificat 0
documents. Podem comprovar al final com el document ha quedat com espervem.</p>
<pre><code>&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "nota" : [  
        8.5,  
        7.5,  
        9  
    ],  
    "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
    }  
}
</code></pre>
<h3 class="azul" id="rename">$rename</h3>
<p>El modificador <strong>$rename</strong> canviar el nom d'un camp. Si no existia, no donar
error i senzillament no el modificar. Hem de cuidar de posar el nou nom del
camp entre cometes, per a que no done error.</p>
<p>La sintaxi 茅s:</p>
<pre><code>{ $rename : { camp1 : "nou_nom1" , camp2 : "nou_nom2" , ... } }
</code></pre>
<p>Per exemple, canviem el nom del camp <strong>nota</strong> a <strong>notes</strong> :</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $rename: {nota:"notes"} } )

&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "adre莽a" : {  
          "carrer" : "Major",  
          "numero" : 7,  
          "cp" : "12502"  
    },  
    "notes" : [  
          8.5,  
          7.5,  
          9  
    ]  
}
</code></pre>
<p>Observeu que l'ha canviat de lloc, cosa que ens fa pensar que en canviar de
nom un camp, el que fa 茅s tornar a crear-lo amb el nou nom, i esborrar el camp
antic.</p>
<p>En aquest exemple tornem a canviar el nom a <strong>nota</strong> , i intentem canviar el
nom a un camp inexistent, <strong>camp1</strong>. No donar error.</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $rename: {camp1: "camp2" , notes:"nota"} } )

&gt; db.alumnes.find()  
{  
  "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
  "nom" : "Abel",  
  "cognoms" : "Bernat Carrera",  
  "edat" : 22,  
  "adre莽a" : {  
      "carrer" : "Major",  
      "numero" : 7,  
      "cp" : "12502"  
  },  
  "nota" : [  
      8.5,  
      7.5,  
      9  
  ]  
}
</code></pre>
<h3 class="azul" id="inc">$inc</h3>
<p>Com cabria esperar, el modificador <strong>$inc</strong> servir per a incrementar un camp
num猫ric. Si el camp existia, l'incrementar en la quantitat indicada. Si no
existia, crear el camp amb un valor inicial de 0, i incrementar el valor amb
la quantitat indicada. La quantitat pot ser positiva, negativa o fins i tot
amb part fraccionria. Sempre funcionar b茅, excepte quan el camp a
incrementar no siga num猫ric, que donar error.</p>
<p>La sintaxi 茅s aquesta:</p>
<pre><code>{ $inc : {camp : quantitat } }
</code></pre>
<p>En els seg眉ents exemples, incrementem un camp nou (per tant el crear amb el
valor especificat), i despr茅s l'incrementem en quantitats positives, negatives
i fraccionries, concretament l'inicialitzem amb un <strong>2</strong> , i desp茅s
l'incrementem en <strong>5</strong> , en <strong>-4</strong> i en <strong>2.25</strong> , per tant el resultat final
ser <strong>5.25</strong> :</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $inc: {puntuacio:2} } )

&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "nota" : [  
        8.5,  
        7.5,  
        9  
    ],  
    "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
    },  
    "puntuacio" : 2  
}

&gt; db.alumnes.updateOne( {nom:"Abel"} , { $inc: {puntuacio:5} } )

&gt; db.alumnes.updateOne( {nom:"Abel"} , { $inc: {puntuacio:-4} } )

&gt; db.alumnes.updateOne( {nom:"Abel"} , { $inc: {puntuacio:2.25} } )

&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "nota" : [  
        8.5,  
        7.5,  
        9  
    ],  
    "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
    },  
    "puntuacio" : 5.25  
}
</code></pre>
<h3 class="azul" id="min">$min</h3>
<p>Actualitza el valor del camp a un valor especificat si aquest 茅s menor que el valor actual del camp.</p>
<pre><code>db.alumnes..updateOne( { nom:"Abel"}, { $min: { puntuacio: 1 } } )
</code></pre>
<p>El valor de puntuaci贸 s'actualitza a 1 perqu猫 茅s menor que el valor actual de 5.  </p>
<h3 class="azul" id="max">$max</h3>
<p>Actualitza el valor del camp a un valor especificat si aquest 茅s major que el valor actual del camp.</p>
<pre><code>db.alumnes..updateOne( { nom:"Abel"}, { $max: { puntuacio: 7 } } )
</code></pre>
<p>El valor de puntuaci贸 s'actualitza a 7 perqu猫 茅s menor que el valor actual de 1.  </p>
<h3 class="azul" id="mul">$mul</h3>
<p>Multiplica el valor d'un camp per un n煤mero.,  $currentDate</p>
<pre><code>    db.alumnes.updateOne({ nom:"Abel"},{ $mul: {puntuacio: 2}})
</code></pre>
<p>L'operador $mul multiiplica el camp puntuaci贸 per 2.</p>
<h3 id="arrays">Arrays</h3>
<p>Per a accedir directament a un element d'un array d'un determinat document es
pot utilitzar la seg眉ent sintaxi:</p>
<pre><code>"array.index"
</code></pre>
<p>Hem de tenir present que el primer element de l'array 茅s el de sub铆ndex 0. I
no us oblideu de tancar-ho tot entre comentes per a que ho puga trobar.</p>
<p>Si no existeix l'element amb el sub铆ndex indicat, donar error.</p>
<p>Per exemple, anem a pujar un punt la primera nota de l'alumne que estem
utilitzant en tots els exemples :</p>
<pre><code>&gt;db.alumnes.updateOne( {nom:"Abel"} , { $inc : { "nota.0" : 1 } } )



&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56df11d778549bdfbf2125e3"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
    },  
    "nota" : [  
        9.5,  
        7.5,  
        9  
    ]  
}
</code></pre>
<h4 id="actualitzacio-y">Actualitzaci贸: $ y $[]</h4>
<p><strong class="azul">$</strong></p>
<p>Identifica un element en un array  per actualitzar sense especificar expl铆citament la posici贸 de l'element en un array.</p>
<p>Ejemplo: Modificar la primera nota mayor a 8 en el array nota </p>
<pre><code>db.alumnes.updateOne(
  { "_id": ObjectId("56df11d778549bdfbf2125e3"), "nota": { $gt: 8 } },
  { $set: { "nota.$": 10 } }
</code></pre>
<p>)</p>
<p><strong class="azul">$[]</strong></p>
<p>L'operador $[] es fa servir per actualitzar tots els elements en un array.</p>
<p>Ejemplo: Aumentar en 1 punto todas las notas en el array nota</p>
<pre><code>db.alumnes.updateOne(
    { "_id": ObjectId("56df11d778549bdfbf2125e3") },
    { $inc: { "nota.$[]": 1 } }
)
</code></pre>
<h4 id="insercio-push">Inserci贸: $push</h4>
<p>La manera m茅s senzilla d'introduir un element en un array 茅s utilitzar
<strong>$push</strong> sense m茅s. Si existia l'array, introduir el o els nous elements al
final. Si no existia l'array, el crear amb aquest o aquestos elements.</p>
<p>La sintaxi 茅s:</p>
<pre><code>{ $push : { clau : element } }
</code></pre>
<p>Per exemple anem a afegir una nota a l'alumne de sempre, i posem-la diferent
per veure que s'introdueix al final:</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $push : { nota : 7 } } )


&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56df11d778549bdfbf2125e3"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
    },  
    "nota" : [  
        9.5,  
        7.5,  
        9,  
        7  
    ]  
}
</code></pre>
<p>Tamb茅 hi ha manera d'introduir un element en una determinada posici贸 que no
siga al final, per貌 es complica prou la cosa, ja que hem d'utilitzar per una
banda el modificador <strong>$position</strong> per a dir on s'ha d'inserir, i per una
altra banda el modificador <strong>$each</strong> per a poder especificar el o els valors
que es volen inserir. Es posa a continuaci贸 煤nicament de forma il路lustrativa.</p>
<p>Per a inserir en una determinada posici贸 hem d'utilitzar obligat貌riament 2
modificadors m茅s:</p>
<ul>
<li><strong>$position</strong> indicar a partir de quina posici贸 es far l'acci贸 (normalment d'inserir en l'array, 茅s a dir, <strong>$push</strong>)</li>
<li><strong>$each</strong> ens permet especificar una s猫rie de valors com un array, i vol dir que es far l'operaci贸 per a cada valor de l'array</li>
</ul>
<p>Els dos modificadors seguiran la sintaxi de sempre, de clau valor, per tant el
conjunt de la sintaxi 茅s:</p>
<pre><code>{ $ push :  
  { clau_del_array :  
    { $position : _posici贸_ ,  
    $each : [ _valors_ ]  
    }  
  }  
}
</code></pre>
<p>Ac铆 tenim un exemple on introdu茂m una nota en la primera posici贸:</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $push : { nota : { $position : 0 , $each
&gt; : [5] } } } )


&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56df11d778549bdfbf2125e3"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "adre莽a" : {  
          "carrer" : "Major",  
          "numero" : 7,  
          "cp" : "12502"  
    },  
    "nota" : [  
        5,  
        9.5,  
        7.5,  
        9,  
        7  
    ]     
}
</code></pre>
<h4 class="azul" id="eliminacio-pop-i-pull">Eliminaci贸: $pop i $pull</h4>
<p>Hi ha m茅s d'una manera d'eliminar elements d'un array.</p>
<p><strong class="azul">$pop</strong></p>
<p>Si volem eliminar el primer element o l'煤ltim, el modificador adequat 茅s
<strong>$pop</strong>. La sintaxi 茅s</p>
<pre><code>{ $pop : { clau : posicio } }
</code></pre>
<p>On en posici贸 podrem posar:</p>
<ul>
<li>-1 , i esborrar el primer element</li>
<li>1 , i esborrar l'煤ltim</li>
</ul>
<p>En els seg眉ents exemples s'esborren primer l'煤ltim element i despr茅s el
primer.</p>
<pre><code>&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56df11d778549bdfbf2125e3"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "adre莽a" : {  
          "carrer" : "Major",  
          "numero" : 7,  
          "cp" : "12502"  
    },  
    "nota" : [  
          5,  
          9.5,  
          7.5,  
          9,  
          7  
    ]  
}



&gt; db.alumnes.updateOne( {nom:"Abel"} , { $pop : { nota : 1 } } )

&gt; db.alumnes.find()  
{  
      "_id" : ObjectId("56df11d778549bdfbf2125e3"),  
      "nom" : "Abel",  
      "cognoms" : "Bernat Carrera",  
      "edat" : 22,  
      "adre莽a" : {  
            "carrer" : "Major",  
            "numero" : 7,  
            "cp" : "12502"  
      },  
      "nota" : [  
              5,  
              9.5,  
              7.5,  
              9  
      ]  
}


&gt; db.alumnes.updateOne( {nom:"Abel"} , { $pop : { nota : -1 } } )

&gt; db.alumnes.find()  
{  
      "_id" : ObjectId("56df11d778549bdfbf2125e3"),  
      "nom" : "Abel",  
      "cognoms" : "Bernat Carrera",  
      "edat" : 22,  
      "adre莽a" : {  
            "carrer" : "Major",  
            "numero" : 7,  
            "cp" : "12502"  
      },  
      "nota" : [  
            9.5,  
            7.5,  
            9  
      ]  
}
</code></pre>
<p><strong class="azul">$pull</strong></p>
<p>Amb aquest modificador esborrarem els elements de l'array que coincidesquen
amb una condici贸, estiguen en la posici贸 que estiguem. Observeu com es pot
eliminar m茅s d'un element.</p>
<p>Per a poder comprovar-lo b茅, primer inserim un altre element al final de
l'array, amb el valor <strong>7.5</strong> (si heu seguit els mateixos exemples que en
aquestos apunts, aquest valor ja es troba en la segona posici贸).</p>
<pre><code>&gt; db.alumnes.updateOne( {nom:"Abel"} , { $push : { nota : 7.5 } } )



&gt; db.alumnes.find()  
{  
    "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Carrera",  
    "edat" : 22,  
    "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
    },  
    "nota" : [  
        9.5,  
        7.5,  
        9,  
        7.5  
    ]  
}
</code></pre>
<p>Ara anem a esborrar amb <strong>$pull</strong> l'element de valor <strong>7.5</strong></p>
<pre><code>&gt; db.alumnes.update( {nom:"Abel"} , { $pull : { nota : 7.5 } } )



&gt; db.alumnes.find()  
{  
      "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
      "nom" : "Abel",  
      "cognoms" : "Bernat Carrera",  
      "edat" : 22,  
      "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
      },  
      "nota" : [  
          9.5,  
          9  
      ]  
}
</code></pre>
<h2 id="38-operadors-de-consulta">3.8 - Operadors de consulta</h2>
<p>En la pregunta anterior hem vist com introduir, eliminar i modificar
documents. Les consultes de documents han segut molt senzilles, per a
comprovar 煤nicament els resultats.</p>
<p>En aquesta pregunta veurem en profunditat la consulta de documents.</p>
<ul>
<li>Funcion <strong>find()</strong>. Veurem en profunditat la seua sintaxi i pot猫ncia.</li>
<li>Limitarem i ordenarem tamb茅 els resultats</li>
<li>Fins i tot podrem elaborar m茅s els resultats, agrupant els resultats, utilitzant funcions d'agregaci贸 (o millor dir operadors d'agregaci贸) i donant-los un aspecte diferent</li>
</ul>
<h3 id="parametres-de-find">Parmetres de find()</h3>
<p>La funci贸 <strong>find()</strong> s'ha comparat tradicionalment amb la sent猫ncia SELECT de
SQL. Sempre tornar un conjunt de documents, que poden variar des de no tornar
cap document, a tornar-los tots els de la col路lecci贸.</p>
<p>La funci贸 <strong>find()</strong> pot tenir uns quants parmetres.</p>
<ul>
<li>
<p>El primer indica una condici贸 o criteri, i tornar aquells documents de la col路lecci贸 que acomplisquen la condici贸 o criteri. Aquesta condici贸 ve donada en forma de document (o objecte) JSON, i 茅s com l'hav铆em vist en la funci贸 <strong>update()</strong> :</p>
<p>db.col_leccio1.find( { clau1 : valor1 } )</p>
</li>
</ul>
<p>Tornar tots els documents de la col路lecci贸 <strong>col_leccio1</strong> que tinguen el
camp <strong>clau1</strong> i que en ell tinguen el valor <strong>valor1</strong>.</p>
<p>Aquest criteri pot ser el complicat que fa莽a falta, formant-lo en JSON. Pot
tenir m茅s d'un membre. En definitiva, tornar aquells documents que facen
<em>matching</em> amb el document del criteri, 茅s a dir, funcionaria com un <strong>and</strong>
en cas que tinga m茅s d'un membre en la condici贸</p>
<pre><code>db.col_leccio1.find( { clau1 : valor1 , clau2 : valor2 } )
</code></pre>
<p>que tornaria aquells documents de la <strong>col_lecci贸1</strong> que tenen el camp
<strong>clau1</strong> amb el valor <strong>valor1</strong> i que tenen el camp <strong>clau2</strong> amb el valor
<strong>valor2</strong></p>
<p>Si no volem posar cap criteri, per a que els torne tots, no posem res com a
parmetre, o encara millor, li passem un document (objecte) buit, de manera
que tots els documents de la col路lecci贸 faran <em>matching</em> amb ell.</p>
<pre><code>db.col_leccio1.find( { } )
</code></pre>
<ul>
<li>El segon parmetre ens servir per a delimitar els camps dels documents que es tornaran. Tamb茅 tindr el format JSON d'un objecte al qual li posarem com a claus els diferents camps que volem que apareguen o no, i com a valor 1 per a que s铆 que apareguen i 0 per a que no apareguen.</li>
</ul>
<p>Si posem algun camp a que s铆 que aparega (茅s a dir, amb el valor 1), els 煤nics
que apareixeran seran aquestos, a m茅s del <strong>_id</strong> que per defecte sempre
apareix.</p>
<pre><code>&gt; db.alumnes.find({},{nom:1})

{ "_id" : ObjectId("56debe3017bf4ed437dc77c8"), "nom" : "Abel" }  
{ "_id" : ObjectId("56dfdbd136d8b095cb6bd57a"), "nom" : "Berta" }
</code></pre>
<p>Per tant si no volem que aparega <strong>_id</strong> posarem:</p>
<pre><code>&gt; db.alumnes.find({},{_id:0})

{ "nom" : "Abel", "cognoms" : "Bernat Cantera", "edat" : 22, "adre莽a" : {"carrer" : "Major", "numero" : 7, "cp" : "12502" }, "nota" : [ 9.5, 9 ] }  
{ "nom" : "Berta", "cognoms" : "Bernat Cantero" }
</code></pre>
<p>I si volem traure 煤nicament el nom:</p>
<pre><code>&gt; db.alumnes.find({},{nom:1,_id:0})

{ "nom" : "Abel" }  
{ "nom" : "Berta" }
</code></pre>
<p>Per 煤ltim, com que a partir d'ara utilitzarem documents m茅s complicats, si
volem que ens apareguen els camps que retornem d'una forma un poc m茅s elegant
o bonica (<em>pretty</em>), posarem aquesta funci贸 al final: <strong>find().pretty()</strong></p>
<pre><code>&gt; db.alumnes.find().pretty()

{  
      "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
      "nom" : "Abel",  
      "cognoms" : "Bernat Cantera",  
      "edat" : 22,  
      "adre莽a" : {  
          "carrer" : "Major",  
          "numero" : 7,  
          "cp" : "12502"  
      },  
      "nota" : [  
          9.5,  
          9  
      ]  
}  
{  
"_id" : ObjectId("56dfdbd136d8b095cb6bd57a"),  
"nom" : "Berta",  
"cognoms" : "Bernat Cantero"  
}
</code></pre>
<h3 id="operadors">Operadors</h3>
<p>Abans de comen莽ar aquesta pregunta, anem a agafar unes dades de prova, que
estan en el fitxer <strong>libros_ejemplo.json</strong></p>
<p>Nom茅s heu de copiar el contingut del fitxer en la terminal del client de
Mongo.</p>
<p>Posem ac铆 el contingut per a que pugueu pegar-li una miradeta sense necessitat
d'obrir-lo. Anir b茅 per als exemples posteriors.</p>
<pre><code>db.libro.insertOne({  
 "_id":"9788408117117",  
  "titulo":"Circo M谩ximo",  
 "autor":"Santiago Posteguillo",  
 "editorial":"Planeta",  
 "enstock":true,  
 "paginas":1100,  
 "precio":21.75,  
 "fecha":new ISODate("2013-08-29T00:00:00Z"),    
 "resumen":"Circo M谩ximo, de Santiago Posteguillo, que ha escrito otras obras de narrativa hist贸rica como Las Legiones Malditas o La traici贸n de Roma, es la segunda parte de la trilog铆a de Trajano, que comenz贸 con Los asesinos del emperador, un relato impactante, descomunal, descrito con un trepidante pulso narrativo destinado a trasla dar al lector a la Roma imperial de los c茅sares. Santiago posteguillo se ha convertido en el autor espa帽ol de referencia de la novela hist贸rica sobre Roma y el mundo antiguo. Bienvenidos al mundo de Marco Ulpio Trajano. Circo M谩ximo es la historia de Trajano y su gobierno, guerras y traiciones, lealtades insobornables e historias de amor imposibles. Hay una vestal, un juicio, inocentes acusados, un abogado especial, mensajes cifrados, c贸digos secretos, batallas campales, fortalezas inexpugnables, asedios sin fin, dos aurigas rivales, el Anfiteatro, los gladiadores y tres carreras de cuadrigas. Hay tambi茅n un caballo especial, diferente a todos, leyes antiguas olvidadas, sacrificios humanos, amargura y terror, pero tambi茅n destellos de nobleza y esperanza, como la llama de Vesta, que mientras arde preserva a Roma. S贸lo que hay noches en las que la llama del Templo de Vesta tiembla. La rueda de la Fortuna comienza entonces a girar. En esos momentos, todo puede pasar y hasta la vida del propio Trajano, aunque 茅l no lo sepa, corre peligro. Y, esto es lo mejor de todo, ocurri贸: hubo un complot para asesinar a Marco Ulpio Trajano."  
})

db.libro.insertOne({  
 "_id":"9788401342158",  
  "titulo":"El juego de Ripper",  
  "autor":"Isabel Allende",  
  "editorial":"Plaza &amp; Janes",  
  "enstock":true,  
  "paginas":480,  
  "precio":21.75,  
 "fecha":new ISODate("2014-03-01T00:00:00Z"),    
  "resumen":"Tal como predijo la astr贸loga m谩s reputada de San Francisco, una oleada de cr铆menes comienza a sacudir la ciudad. En la investigaci贸n sobre los asesinatos, el inspector Bob Mart铆n recibir谩 la ayuda inesperada de un grupo de internautas especializados en juegos de rol, Ripper. 'Mi madre todav铆a est谩 viva, pero la matar谩 el Viernes Santo a medianoche', le advirti贸 Amanda Mart铆n al inspector jefe y 茅ste no lo puso en duda, porque la chica hab铆a dado pruebas de saber m谩s que 茅l y todos sus colegas del Departamento de Homicidios. La mujer estaba cautiva en alg煤n punto de los dieciocho mil kil贸metros cuadrados de la bah铆a de San Francisco, ten铆an pocas horas para encontrarla con vida y 茅l no sab铆a por d贸nde empezar a buscarla",  
})  
  
db.libro.insertOne({  
 "_id":"9788496208919",  
 "titulo":"Juego de tronos: Canci贸n de hielo y fuego 1",  
 "autor":"George R.R. Martin",  
 "editorial":"Gigamesh",  
 "enstock":true,  
 "paginas":793,  
 "precio":9.5,  
 "fecha":new ISODate("2011-11-24T00:00:00Z"),   
 "resumen":"Tras el largo verano, el invierno se acerca a los Siete Reinos. Lord Eddars Stark, se帽or de Invernalia, deja sus dominios para unirse a la corte del rey Robert Baratheon el Usurpador, hombre d铆scolo y otrora guerrero audaz cuyas mayores aficiones son comer, beber y engendrar bastardos. Eddard Stark desempe帽ar谩 el cargo de M ano del Rey e intentar谩 desentra帽ar una mara帽a de intrigas que pondr谩 en peligro su vida... y la de los suyos. En un mundo cuyas estaciones duran d茅cadas y en el que retazos de una magia inmemorial y olvidada surgen en los rincones m谩s sombrios y maravillosos, la traici贸n y la lealtad, la compasi贸n y la sed de venganza, el amor y el poder hacen del juego de tronos una poderosa trampa que atrapa en sus fauces a los personajes... y al lector. 'El regreso triunfal de Martin a la fantas铆a de m谩s alta calidad... con personajes desarrollados con maestr铆a, prosa h谩bil y pura obstinaci贸n.'"  
})

db.libro.insertOne({  
 "_id":"9788499088075",  
 "titulo":"La ladrona de libros",  
 "autor":"Markus Zusak",  
 "editorial":"Debolsillo",  
 "enstock":false,  
 "paginas":544,  
 "precio":9.45,  
 "fecha":new ISODate("2009-01-09T00:00:00Z"),   
 "resumen":"En plena II Guerra Mundial, la peque帽a Liesel hallar谩 su salvaci贸n en la lectura. Una novela preciosa, tremendamente humana y emocionante, que describe las peripecias de una ni帽a alemana de nueve a帽os desde que es dada en adopci贸n por su madre hasta el final de la guerra. Su nueva familia, gente sencilla y nada afecta al na zismo, le ense帽a a leer y a trav茅s de los libros Rudy logra distraerse durante los bombardeos y combatir la tristeza. Pero es el libro que ella misma est谩 escribiendo el que finalmente le salvar谩 la vida.",  
})

db.libro.insertOne({  
 "_id":"9788415140054",  
 "titulo":"La princesa de hielo",  
 "autor":"Camilla Lackberg",  
 "editorial":"Embolsillo",  
 "enstock":true,  
 "precio":11,  
 "fecha":new ISODate("2012-10-30T00:00:00Z"),   
 "resumen":"Misterio y secretos familiares en una emocionante novela de suspense Erica vuelve a su pueblo natal tras el fallecimiento de sus padres, pero se va a encontrar con un nuevo drama. Aparentemente su amiga de la infancia, Alex, se ha suicidado. Pronto se descubre que no solamente fue asesinada sino que estaba embarazada. El primer sospechoso es Anders, un artista fracasado con quien Alex manten铆a una relaci贸n especial. Pero poco despu茅s de ser liberado por falta de pruebas, Anders aparece muerto en su domicilio. Con la ayuda del comisario Patrik, Erica investigar谩 el pasado de su amiga Alex."  
})

db.libro.insertOne({  
 "_id":"9788408113331",  
 "titulo":"Las carreras de Escorpio",  
 "autor":"Maggie Stiefvater",  
 "editorial":"Planeta",  
 "enstock":false,  
 "paginas":290,  
 "precio":17.23,  
 "fecha":new ISODate("2013-06-04T00:00:00Z"),   
 "resumen":"En la peque帽a isla de Thisby, cada noviembre los caballos de agua de la mitolog铆a celta emergen del mar. Y cada noviembre, los hombres los capturan para participar en una emocionante carrera mortal. En las carreras de Escorpio, algunos compiten para ganar. Otros para sobrevivir. Los jinetes intentan dominar a sus caballos de agua el tiempo suficiente para acabar la carrera. Algunos lo consiguen. El resto, muere en el intento. Sean Kendrick es el favorito, y necesita ganar la carrera para ganar, tambi茅n, su libertad. Pero Puck Connolly est谩 dispuesta a ser su m谩s dura adversaria. Ella nunca quiso participar en las carreras. Pero no tiene elecci贸n: o compite y gana o lo pierde todo.",  
})

db.libro.insertOne({  
 "_id":"9788468738895",  
 "titulo":"Las reglas del juego",  
 "autor":"Anna Casanovas",  
 "enstock":true,  
 "paginas":null,  
 "precio":15.90,  
 "fecha":new ISODate("2014-02-06T00:00:00Z"),  
 "resumen":"Susana Lobato tiene la vida perfectamente planeada y est谩 a punto de conseguir todo lo que quiere: va a tener su propio programa de noticias econ贸micas y en dos meses va a casarse con un hombre maravilloso. Pero una noche Tim anula la boda y la abandona para perseguir un sue帽o que no la incluye a ella.Kev MacMurray acaba de cumplir treinta y cinco a帽os y siente que ha llegado el momento de dar un cambio a su vida. No sabe por qu茅, pero 煤ltimamente se est谩 asfixiando y est谩 convencido de que no puede seguir donde est谩. Lo 煤nico que lo retiene es la boda de Tim, su mejor amigo.Pero Tim anula la boda y una noche Kev coincide con Susana y respira por primera vez en mucho tiempo.驴Por qu茅 no le hab铆a sucedido antes? Se supon铆a que 茅l y Susana no se soportaban 驴Desde cu谩ndo siente que si no besa a la prometida de su mejor amigo no podr谩 seguir respirando?Susana nunca hab铆a reaccionado as铆 con nadie. 驴Puede correr el riesgo de averiguar qu茅 pasar谩 si se entrega a Kev?Y qu茅 pasar谩 si vuelve Tim, 驴podr谩n dar un paso atr谩s?.",  
})
</code></pre>
<p>Podeu comprovar que hi ha 7 documents en la nova col路lecci贸 <strong>libro</strong> :</p>
<pre><code>&gt; db.libro.count()  
7
</code></pre>
<p>I tamb茅 podem consultar els t铆tols de forma c貌moda:</p>
<pre><code>&gt; db.libro.find( {} , {titulo:1} )

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo" }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper" }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1" }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros" }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo" }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio" }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego" }
</code></pre>
<p>I un altre exemple, on consultem els llibres que estan en stock (hi ha un camp
boole que ho diu: <strong>enstock</strong>), mostrant t铆tol, editorial i preu</p>
<pre><code>&gt; db.libro.find( {enstock: true} , {titulo:1 , editorial:1 , precio:1} )

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta", "precio" : 21.75 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes", "precio" : 21.75 }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh", "precio" : 9.5 }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "editorial" : "Embolsillo", "precio" : 11 }
</code></pre>
<p>I un 煤ltim exemple, on consultem els llibres que estan en stock i tenen un
preu de 21.75 , mostrant tot excepte el _id i el resum</p>
<pre><code>&gt; db.libro.find( {enstock: true , precio: 21.75} , {titulo:1 , editorial:1 , &gt; precio:1} )

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta", "precio" : 21.75 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes", "precio" : 21.75 }
</code></pre>
<p>Anem a mirar ara operadors que ens serviran per fer millor les consultes.</p>
<h4 id="operadors-de-comparacio">Operadors de comparaci贸</h4>
<p>Fins ara en totes les condicions hem utilitzat la igualtat, si un determinat
camp era igual a un determinat valor. Per貌 hi ha infinitat de consultes en les
quals voldrem altres operacions de comparaci贸: major, major o igual, menor,
...</p>
<p>Aquestos s贸n els operadors de comparaci贸:</p>
<ul>
<li><strong>$lt</strong> (<em>less than</em>) <strong>menor</strong></li>
<li><strong>$lte</strong>(<em>less than or equal</em>)<strong>menor o igual</strong></li>
<li><strong>$gt</strong>(<em>gretaer than</em>) major</li>
<li><strong>$gte</strong> (<em>gretaer than or equal</em>) <strong>major o igual</strong></li>
<li><strong>$ne</strong> (<em>not equal</em>) <strong>distint</strong></li>
<li><strong>$eq</strong> (<em>equal</em>) <strong>igual</strong> (per貌 aquest quasi que no caldria, perqu猫 en no posar res es refereix a la igualtat com fins ara)</li>
</ul>
<p>La sintaxi per a la seua utilitzaci贸 茅s, com sempre, acoplar-se a la sintaxi
JSON:</p>
<pre><code>clau : { $operador : valor [, ... ] }
</code></pre>
<p>Aix铆 per exemple, per a buscar els llibres de m茅s de 10 :</p>
<pre><code>&gt; db.libro.find( { precio : { $gt : 10 } } , { titulo:1 , precio:1 } )

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "precio" : 21.75 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "precio" : 21.75 }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "precio" : 11 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "precio" : 17.23 }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "precio" : 15.9 }
</code></pre>
<p>I per a buscar els llibres entre 10 i 20 :</p>
<pre><code>&gt; db.libro.find( { precio : { $gt : 10 , $lt:20 } } , { titulo:1 , precio:1 })

{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "precio" : 11 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "precio" : 17.23 }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "precio" : 15.9}
</code></pre>
<p>s especialment 煤til per a les dates, ja que dif铆cilment trobarem una data (i
hora) exacta, i voldrem quasi sempre els documents anteriors a una data, o
posteriors, o entre dues dates. Haurem d'anar amb compte pel tractament
especial de les dates: hem de comparar coses del mateix tipus, i per tant la
data amb la qual volem comparar l'haurem de tenir en forma de data:</p>
<pre><code>&gt; var d = new ISODate("2013-01-01T00:00:00Z")  
&gt; db.libro.find( {fecha:{$gte:d} } , {fecha:1} )

{ "_id" : "9788408117117", "fecha" : ISODate("2013-08-29T00:00:00Z") }  
{ "_id" : "9788401342158", "fecha" : ISODate("2014-03-01T00:00:00Z") }  
{ "_id" : "9788408113331", "fecha" : ISODate("2013-06-04T00:00:00Z") }  
{ "_id" : "9788468738895", "fecha" : ISODate("2014-02-06T00:00:00Z") }
</code></pre>
<p><strong class="azul">$in</strong></p>
<p>Servir per a comprovar si el valor d'un camp est entre els d'una llista,
proporcionada com un array. La sitaxi 茅s:</p>
<pre><code>clau : { $in : [valor1 , valor2 , ... , valorN] }
</code></pre>
<p>I ac铆 tenim un exemple, els llibre de les editorials Planeta i Debolsillo:</p>
<pre><code>&gt; db.libro.find( { editorial: {$in : ["Planeta" , "Debolsillo"]} } , {titulo: , editorial:1} )

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta"}  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "editorial" : "Debolsillo" }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta" }
</code></pre>
<p><strong class="azul">$nin</strong></p>
<p>s el contrari, traura els que no estan en la llista.</p>
<pre><code>&gt; db.libro.find( { editorial: {$nin : ["Planeta" , "Debolsillo"]} } , {titulo:1 , editorial:1} )

{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes" }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh" }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "editorial" : "Embolsillo" }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego" }
</code></pre>
<p>Observeu com tamb茅 trau els llibres que no tenen editorial, com 茅s el cas de
l'煤ltim llibre, Las reglas del juego</p>
<p><strong class="azul">$or</strong></p>
<p>L'operador anterior, <strong>$in</strong> , ja feia una esp猫cie de OR, per貌 sempre sobre el
mateix camp. Si l'operaci贸 OR la volem fer sobre camps distints, haurem
d'utilitzar l'operador <strong>$or</strong>. La seua sintaxi ha de jugar amb la
possibilitat de posar molts elements, i per tant conv茅 l'array:</p>
<pre><code>$or : [ {clau1:valor1} , {clau2:valor2} , ... , {clauN:valorN} ]
</code></pre>
<p>Ser cert si s'acompleix alguna de les condicions. Per exemple, traure els
llibres que no estan en stock o que no tenen editorial:</p>
<pre><code>&gt; db.libro.find( { $or : [ {enstock:false} , {editorial:null} ] } , {titulo:1 , enstock:1 , editorial:1} )

{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "editorial" : "Debolsillo", "enstock" : false }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta", "enstock" : false }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "enstock" : true}
</code></pre>
<p><strong class="azul">$not</strong></p>
<p>Serveix per a negar una altra condici贸.</p>
<pre><code>$not : { condici贸 }
</code></pre>
<p>Per exemple els llibres que no s贸n de l'editorial Planeta (observeu que seria
m茅s senzill utilitzar l'operador <strong>$ne</strong> , per貌 茅s per a mostrar el seu
funcionament:</p>
<pre><code>&gt; db.libro.find( { editorial: {$not : {$eq:"Planeta"} } } , {titulo:1 , editorial:1} )

{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes" }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh" }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "editorial" : "Debolsillo" }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "editorial" : "Embolsillo" }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego" }
</code></pre>
<p><strong class="azul">$exists</strong></p>
<p>Servir per a saber els documents que tenen un determinat camp</p>
<pre><code>clau : { $exists : _boolean_ }
</code></pre>
<p>Depenet del valor <em>boolean</em> , el funcionament ser:</p>
<ul>
<li><strong>true</strong> : torna els documents en els quals existeix el camp, encara que el seu valor siga nul</li>
<li><strong>false</strong> : torna els documents que no tenen el camp.</li>
</ul>
<p>Anem a traure els llibres que tenen el camp <strong>paginas</strong> :</p>
<pre><code>&gt; db.libro.find( { paginas: {$exists:true} } , {titulo:1 , paginas:1} )

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "paginas" : 1100 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "paginas" : 480 }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "paginas" : 793 }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "paginas" : 544 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "paginas" : 290 }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "paginas" : null }
</code></pre>
<p>Observeu com ens apareix tamb茅 l'ultim llibre, que t茅 el camp <strong>paginas</strong> amb
el valor <strong>nul</strong>. En canvi si hagu茅rem fet la consulta preguntant pels que s贸n
diferents de nul, no apareixeria aquest 煤ltim llibre:</p>
<pre><code>&gt; db.libro.find( { paginas: {$ne:null} } , {titulo:1 , paginas:1} )

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "paginas" : 1100 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "paginas" : 480 }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "paginas" : 793 }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "paginas" : 544 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "paginas" : 290 }
</code></pre>
<p>I si posem <strong>false</strong> al valor en el <strong>$exists</strong> , 煤nicament ens apareixer el
llibre que no t茅 el camp:</p>
<pre><code>&gt; db.libro.find( { paginas: {$exists:false} } , {titulo:1 , paginas:1} )

{ "_id" : "9788415140054", "titulo" : "La princesa de hielo" }
</code></pre>
<p>I per la mateixa ra贸 que abans, si traiem els que tenen <strong>paginas</strong> a null,
ens eixir tant qui no t茅 el camp, com qui el t茅 per貌 amb valor nul:</p>
<pre><code>&gt; db.libro.find( { paginas: null } , {titulo:1 , paginas:1} )

{ "_id" : "9788415140054", "titulo" : "La princesa de hielo" }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "paginas" : null}
</code></pre>
<p>Per tant, per a segons quines coses, ens interessa l'operador <strong>$exists</strong> , en
compte de jugar amb el nul.</p>
<h4 id="expressions-regulars">Expressions regulars</h4>
<p>Mongo accepta les expressions regulars de forma nativa, cosa que d贸na molta
pot猫ncia per a poder buscar informaci贸 diversa.</p>
<p>Les expressions regulars en Mongo tenen la mateixa sintaxi que en Perl, i que
茅s molt molt pareguda a la major part de llenguatges de programaci贸.</p>
<p>Mirem alguns exemples. Els llibres dins dels quals est la paraula <strong>juego</strong> :</p>
<pre><code>&gt; db.libro.find( { titulo: /juego/ } , {titulo:1} )

{ "_id" : "9788401342158", "titulo" : "El juego de Ripper" }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego" }
</code></pre>
<p>Ara que tenen la paraula <strong>juego</strong> sense importar maj煤scules o min煤scules:</p>
<pre><code>&gt; db.libro.find( { titulo: /juego/i } , {titulo:1} )

{ "_id" : "9788401342158", "titulo" : "El juego de Ripper" }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1" }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego" }
</code></pre>
<p>I ara que tenen la paraula <strong>juego</strong> nom茅s al principi.</p>
<pre><code>&gt; db.libro.find( { titulo: /^juego/i } , {titulo:1} )

{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1" }
</code></pre>
<p>I ara els llibres que en el resum (<strong>resumen</strong>) tenen la paraula <strong>amiga</strong> o
<strong>amigo</strong> , 茅s a dir <strong>amig</strong> seguit d'una <strong>a</strong> o una <strong>o</strong> :</p>
<pre><code>&gt; db.libro.find( { resumen: /amig[ao]/i } , {titulo:1} )

{ "_id" : "9788415140054", "titulo" : "La princesa de hielo" }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego" }
</code></pre>
<h4 id="arrays_1">Arrays</h4>
<p>Les consultes dins d'arrays de Mongo s贸n molt senzilles.</p>
<p>La m茅s senzilla 茅s quan busquem un valor d'un tipus senzill, i en aquest cas
el que far Mongo 茅s buscar en tot l'array per si est aquest valor. s a dir,
exactament igual que el que hem fet fins ara.</p>
<pre><code>    db.col_leccio1.find ( { clau_array : valor } )
</code></pre>
<p>Mirem-ho en un exemple. Anem a crear dos documents que tinguen un array
cadascun, per exemple de colors. El creem en una col路lecci贸 nova, anomenada
<strong>colorins</strong> , en dos documents amb el mateix camp de tipus array, <strong>color</strong> ,
per貌 amb dades diferents<strong><em>*</em></strong>*:</p>
<pre><code>&gt; db.colorins.insert({color: ["roig","blau","groc"]})

&gt; db.colorins.insert({color: ["negre","blanc","roig"]})

&gt; db.colorins.find()

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau", "groc" ] }  
{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "negre", "blanc", "roig" ] }
</code></pre>
<p>Com es veu en la sintaxi, triar els documents que tenen un camp (en aquest cas
d'array) que continga un valor, 茅s igual de senzill que quan es tracta d'un
camp de tipus string, per exemple:</p>
<pre><code>&gt; db.colorins.find({color:"roig"})

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau", "groc" ] }  
{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "negre", "blanc", "roig" ] }
</code></pre>
<p>Tamb茅 podem utilitzar qualsevol dels operadors vistos fins el moment, com per
exemple l'operador <strong>$in</strong> , que mirar els documents que tenen algun dels
colors que s'especifica a continuaci贸:</p>
<pre><code>&gt; db.colorins.find({color: {$in : ["groc","lila"]} })

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau", "groc" ] }
</code></pre>
<p>O per exemple tamb茅 utilitzar <strong>expressions regulars</strong> :</p>
<pre><code>&gt; db.colorins.find({color: /bl/ })

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau", "groc" ] }  
{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "negre", "blanc", "roig" ] }
</code></pre>
<p><strong class="azul">$ all</strong></p>
<p>L'operador <strong>$all</strong> el podem utilitzar quan vulguem seleccionar els documents
que en l'array tiguen <strong>tots</strong> els elements especificats.</p>
<p>Per exemple, anem a buscar els document que tenen el color roig i blau.</p>
<pre><code>&gt; db.colorins.find({color : { $all : ["roig","blau"]} })

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau", "groc" ] }
</code></pre>
<p><strong class="azul">Sub铆ndex</strong></p>
<p>Si volem mirar exactament una determinada posici贸 de l'array, podem
especificar la posici贸 immediatament despr茅s de la clau, <strong>separada per un
punt</strong>. Recordeu que la primera posici贸 茅s la <strong>0</strong>. Hem de posar entre
cometes la clau i la posici贸, sin贸 no sabr trobar-la.</p>
<p>Per exemple, busquem els documents que tenen el roig en la primera posici贸.</p>
<pre><code>&gt; db.colorins.find({"color.0" : "roig"} )

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau", "groc" ] }
</code></pre>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Accedir a una determinada posici贸 茅s fcil, per貌 no 茅s tan fcil accedir a una
posici贸 calculada, per exemple a l'煤ltima posici贸. Ja fa falta coneixements un
poc m茅s avan莽ats de JavaScript, per a posar dins del <strong>find()</strong> una funci贸 en
JavaScript, i actuar dins d'aquesta.</p>
</div>
<hr />
<p>nicament de manera il路lustrativa, posem ac铆 la manera de traure els
documents, l'煤ltim color dels quals 茅s el roig. En ella ens creem una variable
amb l'煤ltim element de l'array (amb <strong>pop()</strong>), i el comparem amb el color
roig, tornant true en cas de que s铆 que siguen iguals:</p>
<pre><code>&gt; db.colorins.find(function() { var a =this.color.pop(); return (a =="roig")})

{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "negre", "blanc", "roig" ] }
</code></pre>
<p>Tamb茅 hi ha una forma alternativa de fer-ho, que 茅s utilitzant l'operador
<strong>$where</strong>, que ens permet crear condicions amb sintaxi JavaScript:</p>
<pre><code>&gt; db.colorins.find({$where:"this.color[this.color.length - 1]=='roig'"})

{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "negre", "blanc", "roig" ] }
</code></pre>
<p><strong class="azul">$size</strong></p>
<p>L'operador <strong>$size</strong> ens servir per a fer condicions sobre el n煤mero
d'elements d'un array.</p>
<p>Incorporem 2 documents nous, amb 2 i 4 elements respectivament, per a poder
comprovar-lo:</p>
<pre><code>&gt; db.colorins.insertOne({color: ["negre","blanc"]})

&gt; db.colorins.insertOne({color: ["taronja","gris","lila","verd"]})


&gt; db.colorins.find()

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau", "groc" ] }  
{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "negre", "blanc", "roig" ] }  
{ "_id" : ObjectId("56e16972aa3c92aaed389da6"), "color" : [ "negre", "blanc" ] }  
{ "_id" : ObjectId("56e16990aa3c92aaed389da7"), "color" : [ "taronja", "gris", "lila", "verd" ] }
</code></pre>
<p>Ara anem a seleccionar els documents que tenen 4 colors</p>
<pre><code>&gt; db.colorins.find({color:{$size:4}})

{ "_id" : ObjectId("56e16990aa3c92aaed389da7"), "color" : [ "taronja", "gris", "lila", "verd" ] }
</code></pre>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>L'operador <strong>$size</strong> nom茅s admet un valor num猫ric, i no es poden concatenar
expressions amb altres operadors, com per exemple intentar la condici贸 que la
grandria de l'array siga menor o igual a un determinat valor. Es pot tornar a
esquivar la q眉esti贸 amb l'operador <strong>$where</strong> , i posar la condici贸 en
JavaScript. Aix铆 la consulta dels documents que tenen 3 o menys colors la
podr铆em traure d'aquesta manera:</p>
<blockquote>
<p>db.colorins.find({$where:"this.color.length&lt;=3"})  </p>
</blockquote>
<p :=":" ObjectId_56e16972aa3c92aaed389da6_="ObjectId(&quot;56e16972aa3c92aaed389da6&quot;)," _="]" __id_="&quot;_id&quot;" _blanc_="&quot;blanc&quot;" _color_="&quot;color&quot;" _negre_="&quot;negre&quot;,">{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau", "groc" ] }<br />
{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "negre", "blanc", "roig" ] }<br /></p>
</div>
<p><strong class="azul">$slice</strong></p>
<p>L'operador <strong>$slice</strong> no 茅s un operador que es puga posar en les condicions
(criteris), sin贸 que servir per a extraure determinats elements de l'array,
pel n煤mero d'ordre d'aquestos elements en l'array. Nom茅s el podrem posar, per
tant, en el segon parmetre del <strong>find()</strong>.</p>
<p>La sintaxi 茅s:</p>
<pre><code>clau : {$slice : x }
</code></pre>
<p>Els valors que pot agafar <strong>x</strong> s贸n:</p>
<ul>
<li>N煤meros positius: ser el n煤mero d'elements del principi (per l'esquerra)</li>
<li>N煤meros negatius: ser el n煤mero d'elements del final (per la dreta)</li>
<li>Un array de 2 elements (<strong>[x,y]</strong>): traur a partir de la posici贸 <strong>x</strong> (0 茅s el primer), tants elements com indique <strong>y</strong></li>
</ul>
<p>Per exemple, anem a traure els dos primers colors de cada document:</p>
<pre><code>&gt; db.colorins.find({} , {color:{$slice:2} })

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "roig", "blau" ] }  
{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "negre", "blanc" ] }  
{ "_id" : ObjectId("56e16972aa3c92aaed389da6"), "color" : [ "negre", "blanc" ] }  
{ "_id" : ObjectId("56e16990aa3c92aaed389da7"), "color" : [ "taronja", "gris" ] }
</code></pre>
<p>O traure l'煤ltim color:</p>
<pre><code>&gt; db.colorins.find({} , {color:{$slice:-1 }})

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "groc" ] }  
{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "roig" ] }  
{ "_id" : ObjectId("56e16972aa3c92aaed389da6"), "color" : [ "blanc" ] }  
{ "_id" : ObjectId("56e16990aa3c92aaed389da7"), "color" : [ "verd" ] }
</code></pre>
<p>O traure el tercer element, tinguen els que tinguen. Recordeu que el segon
element, 茅s el de la posici贸 2, i en volem traure 1.</p>
<pre><code>&gt; db.colorins.find({} , {color:{$slice:[2,1] }})

{ "_id" : ObjectId("56e1438ff6663c8169030e09"), "color" : [ "groc" ] }  
{ "_id" : ObjectId("56e14398f6663c8169030e0a"), "color" : [ "roig" ] }  
{ "_id" : ObjectId("56e16972aa3c92aaed389da6"), "color" : [ ] }  
{ "_id" : ObjectId("56e16990aa3c92aaed389da7"), "color" : [ "lila" ] }
</code></pre>
<h4 id="recerques-en-objectes">Recerques en objectes</h4>
<p>Per a fer recerques en camps que a la seua vegada s贸n objectes (o documents
dins de documents, en la terminologia de Mongo), nom茅s hem de posar la ruta de
les claus separant per mig de punts, i cuidar de posar-la entre cometes.</p>
<p>Aix铆, per exemple, anem a fer una consulta sobre la col路lecci贸 d'alumnes, que
eren uns documents en els quals hi havia algun camp de tipus objecte.</p>
<pre><code>&gt; db.alumnes.find().pretty()

{  
    "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Cantera",  
    "edat" : 22,  
    "adre莽a" : {  
    "carrer" : "Major",  
    "numero" : 7,  
    "cp" : "12502"  
    },  
    "nota" : [  
        9.5,  
        9  
    ]  
}  
{  
"_id" : ObjectId("56dfdbd136d8b095cb6bd57a"),  
"nom" : "Berta",  
"cognoms" : "Bernat Cantero"  
}
</code></pre>
<p>Es podrien traure els documents (els alumnes) que viuen en el codi postal
12502. Ens ha d'eixir l'煤nic alumne del qual tenim l'adre莽a, que justament t茅
aquest codi postal. Recordeu que en la clau (realment clau.subclau), ha d'anar
entre cometes. Hem posat al final <strong>pretty()</strong> per a una millor lectura, per貌
evidentment no 茅s necessari.</p>
<pre><code>&gt; db.alumnes.find({"adre莽a.cp": "12502"}).pretty()

{  
    "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Cantera",  
    "edat" : 22,  
    "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
    },  
    "nota" : [  
        9.5,  
        9  
    ]  
}
</code></pre>
<p>I funcionaria igual amb qualsevol n煤mero de subnivells, 茅s a dir, documents
que tenen objectes, els quals tenen objectes, ... I tamb茅 amb altres tipus
d'operadors, o expressions regulars, ...</p>
<p>Per exemple, tots els alumnes de Castell贸 (el codi postal ha de comen莽ar per
12 i contenir 3 xifres m茅s, 茅s a dir, carcter del 0 al 9, i 3 vegades.</p>
<pre><code>&gt; db.alumnes.find({"adre莽a.cp": /^12[0-9]{3}/}).pretty()

{  
    "_id" : ObjectId("56debe3017bf4ed437dc77c8"),  
    "nom" : "Abel",  
    "cognoms" : "Bernat Cantera",  
    "edat" : 22,  
    "adre莽a" : {  
        "carrer" : "Major",  
        "numero" : 7,  
        "cp" : "12502"  
    },  
    "nota" : [  
        9.5,  
        9  
    ]  
}
</code></pre>
<p><strong class="azul">Limit, Skip i Sort</strong></p>
<p>Una vegada tenim feta una consulta, podem limitar el nombre de documents que
ens ha de tornar, o ordenar-los.</p>
<p>Per a aix貌 hi ha uns m猫todes que apliqiuem al final del <strong>find()</strong> , 茅s a dir,
a continuaci贸 del <strong>find()</strong> , separats per un punt.</p>
<p>Ho aplicarem als llibres, que 茅s on tenim m茅s documents. I no mostrem tots els
camps, per a una millor lectura:</p>
<pre><code>&gt; db.libro.find({} , {titulo:1 , precio:1 , editorial:1})

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta", "precio" : 21.75 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes", "precio" : 21.75 }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh", "precio" : 9.5 }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "editorial" : "Debolsillo", "precio" : 9.45 }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "editorial" : "Embolsillo", "precio" : 11 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta", "precio" : 17.23 }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "precio" : 15.9 }
</code></pre>
<p><strong class="azul">limit(<em>n</em>)</strong></p>
<p>Limita el n煤mero de documents tornats a <em><strong>n</strong></em> documents.</p>
<pre><code>&gt; db.libro.find({} , {titulo:1 , precio:1 , editorial:1}).limit(3)

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta", "precio" : 21.75 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes", "precio" : 21.75 }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh", "precio" : 9.5 }
</code></pre>
<p>Si el n煤mero de documents que fa la consulta 茅s menor que <em><strong>n</strong></em> , doncs se'n
tornaran menys. Aix铆 per exemple, de l'editorial Planeta nom茅s hi ha dos
llibres. Encara que posem limit(3), se'n tornaran 2.</p>
<pre><code>&gt; db.libro.find({editorial:"Planeta"} , {titulo:1 , precio:1 , &gt; editorial:1}).limit(3)

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta", "precio" : 21.75 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial": "Planeta", "precio" : 17.23 }
</code></pre>
<p><strong class="azul">skip(<em>n</em>)</strong></p>
<p>Se saltaran els primers <em><strong>n</strong></em> documents. Si hi haguera menys documents dels
que se salten, doncs no se'n mostraria cap.</p>
<pre><code>&gt; db.libro.find({} , {titulo:1 , precio:1 , editorial:1}).skip(2)

{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh", "precio" : 9.5 }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "editorial" : "Debolsillo", "precio" : 9.45 }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "editorial" : "Embolsillo", "precio" : 11 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta", "precio" : 17.23 }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "precio" : 15.9 }
</code></pre>
<p><strong class="azul">sort()</strong></p>
<p>Serveix per a ordenar. Com a parmetre se li passar un objecte JSON amb les
claus per a ordenar, i els valors seran:</p>
<ul>
<li>1: ordre ascendent</li>
<li>-1: ordre descendent</li>
</ul>
<p>Si posem m茅s d'una clau, s'ordenar pel primer, en cas d'empat pel segon, ...</p>
<p>En aquest exemple ordenem pel preu</p>
<pre><code>&gt; db.libro.find({} , {titulo:1 , precio:1 , editorial:1}).sort({precio:1})

{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "editorial" : "Debolsillo", "precio" : 9.45 }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh", "precio" : 9.5 }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "editorial" : "Embolsillo", "precio" : 11 }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "precio" : 15.9 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta", "precio" : 17.23 }  
{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta", "precio" : 21.75 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes", "precio" : 21.75 }
</code></pre>
<p>I com d茅iem, es pot posar m茅s d'un camp d'ordenaci贸. Per exemple, per
editorial en ordre ascendent, i per preu en ordre descendent</p>
<pre><code>&gt; db.libro.find({} , {titulo:1 , precio:1 , editorial:1}).sort({editorial:1 , precio:-1})

{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "precio" : 15.9 }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "editorial" : "Debolsillo", "precio" : 9.45 }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "editorial" : "Embolsillo", "precio" : 11 }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh", "precio" : 9.5 }  
{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta", "precio" : 21.75 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta", "precio" : 17.23 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes", "precio" : 21.75 }
</code></pre>
<p>Observeu com el primer 茅s el que no t茅 editorial (equivalent a null). I com
que hi ha dos de l'editorial Planeta, apareix primer el m茅s car, i despr茅s el
m茅s barat.</p>
<p>I evidentment, es poden combinar els m猫todes limit, skip i sort.</p>
<p>En aquest exemple traurem el segon i tercer llibre m茅s car. Per a aix貌 ordenem
per preu de forma descendent, saltem un i limitem a 2. No importa l'ordre com
col路locar skip, limit i sort.</p>
<pre><code>&gt; db.libro.find({} , {titulo:1 , precio:1 , &gt; editorial:1}).sort({precio:-1}).skip(1).limit(2)

{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes", "precio" : 21.75 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta", "precio" : 17.23 }
</code></pre>
<h2 id="39-agregacio">3.9 - Agregaci贸</h2>
<p>L'agregaci贸 ens permetr fer consultes molt avan莽ades. s un proc茅s un poc
complicat per貌 molt potent. Ens donar una pot猫ncia quasi com la del SQL quan
comencem a utilitzar el GROUP BY i HAVING.</p>
<p>La t猫cnica que s'utilitza 茅s la del <em><strong>pipeline</strong></em> , 茅s a dir fer una s猫rie de
comandos, cadascun agafa les dades que proporciona l'anterior i a la seua
vegada proporciona les dades al seg眉ent comando. D'aquesta manera es tractar
un conjunt de documents i es faran "operacions" sobre ells seq眉encialment en
blocs: filtrat, projecci贸, agrupacions, ordenaci贸, limitaci贸 i <em>skipping</em>
(saltar alguns).</p>
<p>La sintaxi ser:</p>
<pre><code>db.col_leccio1.aggregate ( _operador $matc_ h ,  _operador $projec_ t ,
_operador $group_ , _operador $sort_ , _operador $limit_ , _operador $skip_ )
</code></pre>
<p>L'ordre dels operadors pot canviar, per貌 hem de tenir en compte que els
comandos s'executen en el ordre en qu猫 els posem (d'esquerra a dreta). Aix铆,
per exemple, pot ser molt convenient posar el primer operador el $match, que
茅s el de seleccionar documents, aix铆 les altres operacions es faran sobre
menys documents i aniran m茅s rpides.</p>
<p>Cada parmetre del aggregate, 茅s a dir, cada operador tindr format JSON, i
per tant sempre ser de l'estil:</p>
<pre><code>{ $operador : { clau:valor , ... } }
</code></pre>
<h4 class="azul" id="match">$match</h4>
<p>Servir per a filtrar els documents. Aleshores, l'agregaci贸 nom茅s afectar als
documents seleccionats. Es poden utilitzar tots els operadors que hem anat
estudiant.</p>
<p>El seg眉ent exemple selecciona els documents de l'editorial Planeta. Ho fa per
mig de <strong>aggregate</strong> , per貌 com no fem res m茅s, senzillament selecciona els
documents.</p>
<pre><code>&gt; db.libro.aggregate({$match:{editorial:"Planeta"}})
</code></pre>
<p>En el seg眉ent exemple, a m茅s de seleccionar els de l'editorial Planeta despr茅s
apliquem una projecci贸 sobre els camps t铆tol i editorial, per a poder
visualitzar millor el resultat.</p>
<pre><code>&gt; db.libro.aggregate({$match:{editorial:"Planeta"}},{$project:{titulo:1,editorial:1}})

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta"}  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial": "Planeta" }
</code></pre>
<h4 class="azul" id="project">$project</h4>
<p>Ens permet projectar sobre determinats camps del document, per貌 茅s molt m茅s
complet que en la projecci贸 "normal" que hav铆em fet fins ara, ja que permet
tamb茅 renomenar camps, fer clculs, etc.</p>
<p><strong>Projeccci贸</strong></p>
<p>La manera m茅s senzilla, evidentment 茅s projectar sobre alguns camps dels
existents, i el funcionament 茅s id猫ntic al de l'altra vegada (valors 1 per a
que apareguen, 0 per a que no apareguen; per defecte<strong>_id</strong> sempre apareix):</p>
<pre><code>&gt; db.libro.aggregate({$project:{titulo:1,editorial:1}})

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "editorial" : "Planeta" }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "editorial" : "Plaza &amp; Janes" }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "editorial" : "Gigamesh" }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "editorial" : "Debolsillo" }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "editorial" : "Embolsillo" }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta" }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego" }
</code></pre>
<p><strong class="azul">Renomenar</strong></p>
<p><strong>$project</strong> tamb茅 ens permet renomenar camps existents (despr茅s veurem que tamb茅
clculs). La manera ser posar d'aquest manera:</p>
<pre><code>{ $project : { "nom_nou" : "$camp_vell" }}
</code></pre>
<p>El secret est en el d貌lar que va davant del camp vell, ja que d'aquesta
manera ens referim al valor d'aquest camp. Aix铆 per exemple renomenem el camp
<strong>enstock</strong> a <strong>disponible</strong> , a banda de traure el t铆tol:</p>
<pre><code>&gt; db.libro.aggregate({$project:{titulo:1 , disponible:"$enstock"}})

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "disponible" : true }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "disponible" : true }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1" disponible" : true }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "disponible" : false }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "disponible" : true }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "disponible" : false }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "disponible" : true }
</code></pre>
<p><strong class="azul">Camps calculats</strong></p>
<p>Amb aquest nom gen猫ric ens referirem a tots els clculs, expressions i m茅s
coses que podrem posar per a trasnsformar el que ja tenim. Com veiem, a莽貌 茅s
molt m茅s potent que la projecci贸 normal.</p>
<ul>
<li><strong>Expressions matemtiques</strong> : Podrem aplicar f贸rmules per a sumar (<strong>$add</strong>), restar (<strong>$subtract</strong>), multiplicar (<strong>$multiply</strong>), dividir (<strong>$divide</strong>) i m茅s coses (pot猫ncia, arrel quadrada, valor absolut, m貌dul, ...). Cada operaci贸 t茅 el seu operador que ser una paraula precedida pel d貌lar, i amb la sintaxi de JSON, on posarem els operands en un array. </li>
</ul>
<p>Per exemple, traurem t铆tol del llibre, preu i preu en pessetes (multiplicant
per 166.386)</p>
<pre><code>&gt; db.libro.aggregate({$project:{titulo:1 , precio:1 , preu_pessetes:{$multiply:["$precio" , 166.386]}}})

{ "_id" : "9788408117117", "titulo" : "Circo M谩ximo", "precio" : 21.75, "preu_pessetes" : 3618.8955 }  
{ "_id" : "9788401342158", "titulo" : "El juego de Ripper", "precio" : 21.75, "preu_pessetes" : 3618.8955 }  
{ "_id" : "9788496208919", "titulo" : "Juego de tronos: Canci贸n de hielo y fuego 1", "precio" : 9.5, "preu_pessetes" : 1580.667 }  
{ "_id" : "9788499088075", "titulo" : "La ladrona de libros", "precio" : 9.45, "preu_pessetes" : 1572.3476999999998 }  
{ "_id" : "9788415140054", "titulo" : "La princesa de hielo", "precio" : 11, "preu_pessetes" : 1830.2459999999999 }  
{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "precio" : 17.23, "preu_pessetes" : 2866.83078 }  
{ "_id" : "9788468738895", "titulo" : "Las reglas del juego", "precio" : 15.9, "preu_pessetes" : 2645.5374 }
</code></pre>
<ul>
<li><strong>Expressions de dates</strong> : Ja veurem i ja podem anar intuint que moltes agregacions estaran basades en el temps, per a poder fer consultes de documents de la setmana passada, o el mes passat, ... Per a poder fer aquestes agregacions, hi ha un conjunt d'expressions que permeten extraure fcilment d'una data el seu dia, mes, any, ... en forma de n煤mero</li>
</ul>
<p>S贸n les expressions: <strong>$year, $month, $week, $dayOfMonth, $DayOfWeek,
$dayOfYear, $hour, $minute</strong> i <strong>$second</strong>.</p>
<p>En el seg眉ent exemple traurem tots els documents, projectant per la data, any
i mes:</p>
<pre><code>&gt; db.libro.aggregate({$project : {fecha:1 , a帽o:{$year:"$fecha"} , mes:{$month:"$fecha"}}})

{ "_id" : "9788408117117", "fecha" : ISODate("2013-08-29T00:00:00Z"), "a帽o" : 2013, "mes" : 8 }  
{ "_id" : "9788401342158", "fecha" : ISODate("2014-03-01T00:00:00Z"), "a帽o" : 2014, "mes" : 3 }  
{ "_id" : "9788496208919", "fecha" : ISODate("2011-11-24T00:00:00Z"), "a帽o" : 2011, "mes" : 11 }  
{ "_id" : "9788499088075", "fecha" : ISODate("2009-01-09T00:00:00Z"), "a帽o" : 2009, "mes" : 1 }  
{ "_id" : "9788415140054", "fecha" : ISODate("2012-10-30T00:00:00Z"), "a帽o" : 2012, "mes" : 10 }  
{ "_id" : "9788408113331", "fecha" : ISODate("2013-06-04T00:00:00Z"), "a帽o" : 2013, "mes" : 6 }  
{ "_id" : "9788468738895", "fecha" : ISODate("2014-02-06T00:00:00Z"), "a帽o" : 2014, "mes" : 2 }
</code></pre>
<ul>
<li>
<p><strong>Expressions de strings</strong> : Ens permeten manipular els strings per a extraure subcadenes, concatenar, passar a maj煤scules o min煤scules. Aquestes s贸n algunes de les funcions:</p>
<blockquote>
<ul>
<li><strong>$substr : [exp , inici , llargria]</strong> : extrau una subcadena del string del primer parmetre, des de la posici贸 que indica el segon parmetre (o primer carcter) i tants carcters com el tercer parmetre</li>
<li><strong>$concat : [ exp1 , exp2 , ...]</strong> : concatena les expressions que hi ha en l'array</li>
<li><strong>$toLower : exp</strong> i <strong>$toUpper : exp</strong> : converteixen l'expressi贸 a maj煤scules i min煤scules respectivament</li>
</ul>
</blockquote>
</li>
</ul>
<p>Per exemple, anem a traure el t铆tol dels llibres amb l'autor entre par猫ntesis:</p>
<pre><code>&gt; db.libro.aggregate({$project: { "Llibre:" : {$concat : ["$titulo" , " (" , "$autor" , ")"]}}})

{ "_id" : "9788408117117", "Llibre:" : "Circo M谩ximo (Santiago Posteguillo)" }  
{ "_id" : "9788401342158", "Llibre:" : "El juego de Ripper (Isabel Allende)" }  
{ "_id" : "9788496208919", "Llibre:" : "Juego de tronos: Canci贸n de hielo y fuego 1 (George R.R. Martin)" }  
{ "_id" : "9788499088075", "Llibre:" : "La ladrona de libros (Markus Zusak)" }  
{ "_id" : "9788415140054", "Llibre:" : "La princesa de hielo (Camilla Lackberg)" }  
{ "_id" : "9788408113331", "Llibre:" : "Las carreras de Escorpio (Maggie Stiefvater)" }  
{ "_id" : "9788468738895", "Llibre:" : "Las reglas del juego (Anna Casanovas)"}
</code></pre>
<p>I ara el mateix, per貌 amb el t铆tol en maj煤scules:</p>
<pre><code>&gt; db.libro.aggregate({$project: { "Llibre:" : {$concat : [{$toUpper:"$titulo"}, " (" , "$autor" , ")"]}}})

{ "_id" : "9788408117117", "Llibre:" : "CIRCO M谩XIMO (Santiago Posteguillo)" }  
{ "_id" : "9788401342158", "Llibre:" : "EL JUEGO DE RIPPER (Isabel Allende)" }  
{ "_id" : "9788496208919", "Llibre:" : "JUEGO DE TRONOS: CANCI贸N DE HIELO Y FUEGO 1 (George R.R. Martin)" }  
{ "_id" : "9788499088075", "Llibre:" : "LA LADRONA DE LIBROS (Markus Zusak)" }  
{ "_id" : "9788415140054", "Llibre:" : "LA PRINCESA DE HIELO (Camilla Lackberg)" }  
{ "_id" : "9788408113331", "Llibre:" : "LAS CARRERAS DE ESCORPIO (Maggie Stiefvater)" }  
{ "_id" : "9788468738895", "Llibre:" : "LAS REGLAS DEL JUEGO (Anna Casanovas)" }
</code></pre>
<h4 class="azul" id="group">$group</h4>
<p>Realitza grups sobre els documents seleccionats pr猫viament, per a valors
iguals del camp o expressions que determinem. Posteriorment, amb els grups,
podrem realitzar operacions, com sumar o traure la mitjana d'alguna quantitat
dels documents del grup, o el mxim o m铆nim, ...</p>
<p>Per a poder agrupar, haurem de definir com a <strong>_id</strong> del grup el camp o camps
pels valors dels quals volem agrupar. Per exemple, si volem agrupar els
llibres per l'editorial, haurem de definir el <strong>_id</strong> del grup el camp
editorial</p>
<pre><code>$group : { "_id" : _camp o camps_ }
</code></pre>
<p>Si agrupem per un 煤nic camp, senzillament el posem amb un d貌lar davant i entre
cometes. Si 茅s m茅s d'un camp, els posem com un objecte. Per exemple, agrupem
per editorial:</p>
<pre><code>&gt; db.libro.aggregate( { $group : { "_id" : "$editorial" } } )

{ "_id" : "Debolsillo" }  
{ "_id" : null }  
{ "_id" : "Gigamesh" }  
{ "_id" : "Embolsillo" }  
{ "_id" : "Plaza &amp; Janes" }  
{ "_id" : "Planeta" }
</code></pre>
<p>Podem observar com hi ha algun llibre que no t茅 editorial.</p>
<p>Ara agrupem per any de publicaci贸 (l'extraurem del camp <strong>fecha</strong>):</p>
<pre><code>&gt; db.libro.aggregate( { $group : { "_id" : { "any" : { $year : "$fecha" } } }} )

{ "_id" : { "any" : 2012 } }  
{ "_id" : { "any" : 2009 } }  
{ "_id" : { "any" : 2011 } }  
{ "_id" : { "any" : 2014 } }  
{ "_id" : { "any" : 2013 } }
</code></pre>
<p>I ara agrupem per editorial i any de publicaci贸 (els dos llibres de Planeta
s贸n del 2013)</p>
<pre><code>&gt; db.libro.aggregate( { $group : { "_id" : { "Editorial" : "$editorial" , "any" : { $year : "$fecha" } } } } )

{ "_id" : { "Editorial" : "Embolsillo", "any" : 2012 } }  
{ "_id" : { "any" : 2014 } }  
{ "_id" : { "Editorial" : "Debolsillo", "any" : 2009 } }  
{ "_id" : { "Editorial" : "Gigamesh", "any" : 2011 } }  
{ "_id" : { "Editorial" : "Plaza &amp; Janes", "any" : 2014 } }  
{ "_id" : { "Editorial" : "Planeta", "any" : 2013 } }
</code></pre>
<p><strong class="azul">Operadors d'agrupaci贸</strong></p>
<p>Ens permetran fer alguna operaci贸 sobre els documents del grup. Es posen com a
segon parmetre del grup (despr茅s de la definici贸 del <strong>_id</strong>).</p>
<ul>
<li><strong>$sum : valor</strong> : sumar el valor de tots els documents del grup. El valor pot ser un camp num猫ric, o alguna altra cosa m茅s complicada.</li>
<li><strong>$avg : valor</strong> : calcular la mitjana dels valors per als documents del grup</li>
<li><strong>$max : valor</strong> : mxim</li>
<li><strong>$min : valor</strong> : m铆nim</li>
<li><strong>$first : exp</strong> : agafar el primer valor de l'expressi贸 del grup, ignorant les altres del grup</li>
<li><strong>$last : exp</strong> : agafar l'煤ltim</li>
</ul>
<p>La documentaci贸 diu que tamb茅 existeix l'operador <strong>$count</strong> , per貌 a partir
d'una determinada versi贸. Es pot substituir la seua utilitzaci贸 per l'operador
<strong>$sum</strong> , sumant la quantitat 1.</p>
<p>Per exemple, la suma dels preus dels llibres de cada editorial:</p>
<pre><code>&gt; db.libro.aggregate( { $group : { "_id" : "$editorial" , "suma_preus" : {$sum : "$precio"} } } )

{ "_id" : "Debolsillo", "suma_preus" : 9.45 }  
{ "_id" : null, "suma_preus" : 15.9 }  
{ "_id" : "Gigamesh", "suma_preus" : 9.5 }  
{ "_id" : "Embolsillo", "suma_preus" : 11 }  
{ "_id" : "Plaza &amp; Janes", "suma_preus" : 21.75 }  
{ "_id" : "Planeta", "suma_preus" : 38.980000000000004 }
</code></pre>
<p>O la mitjana dels preus de cada any:</p>
<pre><code>&gt; db.libro.aggregate( { $group : { "_id" : { "any" : { $year : "$fecha" } } , "mitjana preus" : { $avg : "$precio" } } } )

{ "_id" : { "any" : 2012 }, "mitjana preus" : 11 }  
{ "_id" : { "any" : 2009 }, "mitjana preus" : 9.45 }  
{ "_id" : { "any" : 2011 }, "mitjana preus" : 9.5 }  
{ "_id" : { "any" : 2014 }, "mitjana preus" : 18.825 }  
{ "_id" : { "any" : 2013 }, "mitjana preus" : 19.490000000000002 }
</code></pre>
<p>I ara intentem comptar la quantitat de llibres de cada editorial:</p>
<pre><code>&gt; db.libro.aggregate( { $group : { "_id" : "$editorial" , "quants" : { $sum :
1} } } )

{ "_id" : "Debolsillo", "quants" : 1 }  
{ "_id" : null, "quants" : 1 }  
{ "_id" : "Gigamesh", "quants" : 1 }  
{ "_id" : "Embolsillo", "quants" : 1 }  
{ "_id" : "Plaza &amp; Janes", "quants" : 1 }  
{ "_id" : "Planeta", "quants" : 2 }
</code></pre>
<h4 class="azul" id="sort">$sort</h4>
<p>Serveix per a ordenar i segueix la mateixa sintxi que en les consultes normal
(1: ordre ascendent; -1: ordre descendent). Podrem ordenar pels camps normals
o per camps clalculats.</p>
<p>Per exemple ordenem per la suma de preus de cada editorial:</p>
<pre><code>&gt; db.libro.aggregate( { $group : { "_id" : "$editorial" , "suma_preus" : {
$sum : "$precio"} } } , { $sort : { suma_preus : 1 } })

{ "_id" : "Debolsillo", "suma_preus" : 9.45 }  
{ "_id" : "Gigamesh", "suma_preus" : 9.5 }  
{ "_id" : "Embolsillo", "suma_preus" : 11 }  
{ "_id" : null, "suma_preus" : 15.9 }  
{ "_id" : "Plaza &amp; Janes", "suma_preus" : 21.75 }  
{ "_id" : "Planeta", "suma_preus" : 38.980000000000004 }
</code></pre>
<p>I ara ordenem de forma descendent per la mitjana de preus de cada any:</p>
<pre><code>&gt; db.libro.aggregate( { $group : { "_id" : {"any":{$year:"$fecha"}} , "mitjana
preus":{$avg:"$precio"} } } , {$sort:{"mitjana preus":-1}})

{ "_id" : { "any" : 2013 }, "mitjana preus" : 19.490000000000002 }  
{ "_id" : { "any" : 2014 }, "mitjana preus" : 18.825 }  
{ "_id" : { "any" : 2012 }, "mitjana preus" : 11 }  
{ "_id" : { "any" : 2011 }, "mitjana preus" : 9.5 }  
{ "_id" : { "any" : 2009 }, "mitjana preus" : 9.45 }
</code></pre>
<h4 class="azul" id="limit">$limit</h4>
<p>Limita el resultat del aggregate al n煤mero indicat.</p>
<p>Per exemple, els tres anys de mitjana de preus m茅s cara. s com l'煤ltim
exemple, afegint el l铆mit:</p>
<pre><code>&gt; db.libro.aggregate({$group:{"_id":{"any":{$year:"$fecha"}},"mitjana
preus":{$avg:"$precio"}}} , {$sort:{"mitjana preus":-1}} , {$limit:3})

{ "_id" : { "any" : 2013 }, "mitjana preus" : 19.490000000000002 }  
{ "_id" : { "any" : 2014 }, "mitjana preus" : 18.825 }  
{ "_id" : { "any" : 2012 }, "mitjana preus" : 11 }
</code></pre>
<h4 class="azul" id="skip">$skip</h4>
<p>Salta el n煤mero indicat</p>
<p>En l'exemple anterior, ara saltem els 3 primers:</p>
<pre><code>&gt; db.libro.aggregate({$group:{"_id":{"any":{$year:"$fecha"}},"mitjana
preus":{$avg:"$precio"}}} , {$sort:{"mitjana preus":-1}} , {$skip:3})

{ "_id" : { "any" : 2011 }, "mitjana preus" : 9.5 }  
{ "_id" : { "any" : 2009 }, "mitjana preus" : 9.45 }
</code></pre>
<h2 id="310-resum-comandos">3.10 - Resum Comandos</h2>
<p>Per a qualsevol operaci贸 s'ha de posar <strong>db</strong> seguit del nom de la col路lecci贸,
i despr茅s l'operaci贸 que volem fer.</p>
<p><strong class="azul">Operacions sobre el servidor MongoDB</strong>  </p>
<ul>
<li>Connectar a MongoDB =&gt; <code>mongo</code>  </li>
<li>Seleccionar la base de dades =&gt; <code>use miBaseDeDatos</code>  </li>
<li>Mostrar totes les bases de dades en el teu servidor MongoDB =&gt; <code>show dbs</code>  </li>
<li>Mostrar els usuaris de la base de dades actual =&gt; <code>show users</code>  </li>
<li>Mostrar els rols definits en la base de dades actual =&gt; <code>show roles</code>  </li>
<li>Mostrar la versi贸 del servidor MongoDB =&gt; <code>db.version()</code>  </li>
<li>Mostrar el nom de la BD del servidor MongoDB =&gt; <code>db.getName()</code>  </li>
<li>Mostrar les operacions que sestan executant en el servidor =&gt; <code>db.currentOp()</code>  </li>
<li>Mostrar informaci贸 de la base de dades actual =&gt; <code>db.stats()</code>  </li>
</ul>
<p><strong class="azul">Operacions sobre col路leccions</strong>  </p>
<ul>
<li>Mostrar totes les col路leccions en la base de dades seleccionada =&gt; <code>show collections</code>  </li>
<li>Crear una col路lecci贸 dins de la base de dades on estiguem situats =&gt; <code>db.createCollection("nom_de_la_col路lecci贸")</code>  </li>
</ul>
<p><strong class="azul">Altres funcions sobre una col路lecci贸</strong>  <code>db.nom_de_la_col路lecci贸.XXXXXXX</code>  </p>
<ul>
<li>Eliminar la col路lecci贸 =&gt; <code>drop()</code>  </li>
<li>Formatar leixida =&gt; <code>pretty()</code>  </li>
<li>Comptar de manera precisa el nombre de documents de la col路lecci贸 =&gt; <code>countDocuments()</code> </li>
<li>Realitzar un recompte per a una estimaci贸 rpida =&gt; <code>estimatedDocumentCount()</code>  </li>
</ul>
<p><strong class="azul">Operacions CRUD dins de la col路lecci贸</strong>  <code>db.nom_de_la_col路lecci贸.XXXXXXX</code></p>
<ul>
<li><strong>Create (crear document/s)</strong> =&gt; <code>insertOne()</code>, <code>insertMany()</code>  </li>
<li><strong>Read (llegir, buscar document/s)</strong> =&gt; <code>findOne()</code>, <code>find()</code>, <code>group()</code>, <code>sort()</code>, <code>limit()</code>, <code>skip()</code>  </li>
<li><strong>Update (modificar document/s)</strong> =&gt; <code>updateOne()</code>, <code>updateMany()</code>, <code>replaceOne()</code>  </li>
<li><strong>Delete (eliminar document/s)</strong> =&gt; <code>deleteOne()</code>, <code>deleteMany()</code>  </li>
</ul>
<p><strong class="azul">Operacions avan莽ades</strong>  </p>
<ul>
<li>Pipeline o agregaci贸 =&gt; <code>aggregation()</code>  </li>
</ul>
<h2 id="exercicis"><img alt="锔" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/png/270f.png" title=":pencil2:" /> Exercicis</h2>
<h3 id="exercici-2">Exercici 2</h3>
<p>Sobre la teua Base de Dades <strong>MONGODB</strong> treballarem sobre la col路lecci贸
<strong>libro</strong>, la mateixa que hem utilitzat en els exemples. Si no la tens
creada, executa les sent猫ncies del principi de la pregunta <strong>3.8 - Operadors de consulta/ Operadors</strong>. Fes les seg眉ents consultes. Copia-les en un 煤nic fitxer de text, de forma numerada. s aquest fitxer el que haurs de pujar.</p>
<ol>
<li>Busca els llibres que tenen m茅s de 500 pgines. Visualitza el _id, el t铆tol i el n煤mero de pgines.</li>
<li>Busca els llibres de l'any 2014. Visualitza 煤nicament t铆tol i data.</li>
<li>Busca els llibres de l'editorial Planeta. Visualitza 煤nicament t铆tol i editorial.</li>
<li>Busca els llibres de l'editorial Planeta de m茅s de 500 pgines. Visualitza 煤nicament t铆tol, editorial i pgines.</li>
<li>Busca els llibres que no tenen editorial. Visualitza 煤nicament t铆tol i editorial.</li>
<li>Busca els llibres que en el resum contenen la paraula <strong>caballo</strong>. Visualitza el resum per poder comprovar-ho. Han d'eixir 2 llibres, <strong>Circo m谩ximo</strong> i <strong>Las carreras de Escorpio</strong>.</li>
<li>
<p>Utilitzant la funci贸 <strong>aggregate</strong> , trau l'editorial i la mitjana de pgines d'aquelles editorials que tenen una mitjana de pgines superior a 500. Eixiran 3 editorials.</p>
</li>
<li>
<p>Incrementar el preu dels llibres de l'editorial Planeta en 2 (recordeu que per a modificar m茅s d'un document, hem de posar com a tercer parmetre l'opci贸 <strong>{multi:true}</strong>).</p>
</li>
<li>Crear el camp editorial amb el valor nul, per a tots aquells documents que no tinguen el camp editorial.</li>
<li>Fer l'operaci贸 inversa: eliminar el camp editorial per a tots aquells que el tinguen nul.</li>
<li>Traure l'any del llibre, a partir de la <strong>fecha</strong> (ser un camp calculat anomenat <strong>a帽o</strong>).</li>
<li>Aprofita el camp anterior per a traure els llibres estrictament anteriors a l'any 2013. Visualitza <strong>titulo</strong> , <strong>fecha</strong> i <strong>a帽o</strong>.</li>
</ol>
<h3 id="exercici-3">Exercici 3</h3>
<p>Aquest exercici l'has de realitzar sobre la teua BD de MongoDB (col路lecci贸 <strong>pelicula</strong>).</p>
<pre><code>title : Fight Club
writer : Chuck Palahniuk
year : 1999
actors : [
  Brad Pitt
  Edward Norton ]


title : Pulp Fiction
writer : Quentin Tarantino
year : 1994
actors : [
  John Travolta
  Uma Thurman ]



title : Inglorious Basterds
writer : Quentin Tarantino
year : 2009
actors : [
  Brad Pitt
  Diane Kruger
  Eli Roth ]


title : The Hobbit: An Unexpected Journey
writer : J.R.R. Tolkein
year : 2012
franchise : The Hobbit


title : The Hobbit: The Desolation of Smaug
writer : J.R.R. Tolkein
year : 2013
franchise : The Hobbit


title : The Hobbit: The Battle of the Five Armies
writer : J.R.R. Tolkein
year : 2012
franchise : The Hobbit
synopsis : Bilbo y compa帽铆a se ven obligados a participar en una guerra contra una serie de combatientes y evitar que la Lonely Mountain caiga en manos de una oscuridad creciente.



title : Pee Wee Herman's Big Adventure


title : Avatar
</code></pre>
<ol>
<li>Inserir tots els documents anteriors. Ha de ser <strong>obligat貌riament</strong> amb una 煤nica sent猫ncia, per a la qual cosa pots utilitzar variables, una per a cada document.</li>
<li>Consultar tots els documents</li>
<li>Obtenir els documents amb <strong>writer</strong> igual a <strong>"Quentin Tarantino"</strong></li>
<li>Obtenir els documents amb <strong>actors</strong> que incloguen a <strong>"Brad Pitt"</strong></li>
<li>Obtenir els documents amb <strong>franchise</strong> igual a <strong>"The Hobbit"</strong></li>
<li>Obtenir totes les pel路l铆cules dels anys 90.</li>
<li>Obtenir les pel路l铆cules estrenades entre l'any 2000 i el 2010.</li>
<li>Agregar sinopsis a <strong>"The Hobbit: An Unexpected Journey"</strong> : <ul>
<li>"Un hobbit reacio, Bilbo Baggins, se dirige a Lonely Mountain con un en茅rgico grupo de enanos para reclamar su hogar en la monta帽a, y el oro que contiene, del drag贸n Smaug".</li>
</ul>
</li>
<li>Agregar sinopsis a <strong>"The Hobbit: The Desolation of Smaug</strong> ": <ul>
<li>"Los enanos, junto con Bilbo Baggins y Gandalf the Grey, contin煤an su b煤squeda para recuperar Erebor, su tierra natal, de manos de Smaug. Bilbo Baggins est谩 en posesi贸n de un anillo misterioso y m谩gico".</li>
</ul>
</li>
<li>Agregar un actor anomenat <strong>"Samuel L. Jackson"</strong> a la pel路l铆cula "Pulp Fiction"</li>
<li>Trobar les pel路l铆cules que en la sinopsis continguen la paraula <strong>"Bilbo"</strong></li>
<li>Trobar les pel路l铆cules que en la sinopsis continguen la paraula <strong>"Gandalf"</strong></li>
<li>Trobar les pel路l铆cules que en la sinopsis continguen la paraula <strong>"Bilbo"</strong> i no la paraula <strong>"Gandalf"</strong>. S'aconsella utilitzar l'operador <strong>$and</strong></li>
<li>Trobar les pel路l铆cules que en la sinopsis continguen la paraula <strong>"enanos"</strong> o <strong>"hobbit"</strong></li>
<li>Trobar les pel路l铆cules que en la sinopsis continguen les paraules <strong>"oro"</strong> i <strong>"drag贸n"</strong></li>
<li>Eliminar la pel路l铆cula <strong>"Pee Wee Herman's Big Adventure"</strong></li>
<li>Eliminar la pel路l铆cula <strong>"Avatar"</strong></li>
</ol>
<p>Llicenciat sota la  <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Llic猫ncia Creative Commons Reconeixement NoComercial
SenseObraDerivada 4.0</a></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../2__bases_de_dades_clauvalor/" class="btn btn-neutral float-left" title="2 - Bases de Dades Clau-Valor (Redis)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../4_relaciones_mongo/" class="btn btn-neutral float-right" title="4 - Relacions en MongoDB">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../2__bases_de_dades_clauvalor/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../4_relaciones_mongo/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
